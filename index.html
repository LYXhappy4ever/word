<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•è¯è®­ç»ƒå™¨ v13.0 (å…¨èƒ½å»é‡ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-bg: #EEF2FF;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --focus-ring: #818cf8;
            --radius: 16px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        html { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font-stack); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        * { box-sizing: border-box; }

        /* --- ç»„ä»¶æ ·å¼ --- */
        .btn { border: none; padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; outline: none; white-space: nowrap; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
        .btn-outline { border: 1px solid #E5E7EB; background: white; color: var(--text-main); }
        
        select { padding: 8px 30px 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: white; font-size: 13px; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 10px; }

        .hidden { display: none !important; }
        .view { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        /* --- ä¹¦æ¶è§†å›¾ --- */
        header { background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; z-index: 50; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary); }

        #bookshelf-view { overflow-y: auto; padding: 16px; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; padding-bottom: 40px; }
        
        .book-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 2px solid transparent;
            display: flex; justify-content: space-between; align-items: center;
            height: 90px; position: relative; overflow: hidden; transition: all 0.2s; cursor: pointer;
        }
        .book-card:hover { transform: translateY(-2px); box-shadow: 0 8px 12px -3px rgba(0,0,0,0.1); border-color: #e5e7eb; }
        .book-card.drag-over { border: 2px dashed var(--success); background: #ecfdf5; transform: scale(0.98); }
        
        .book-info { flex: 1; overflow: hidden; }
        .book-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-meta { font-size: 12px; color: #9CA3AF; display: flex; gap: 10px; align-items: center; }
        .badge-unmastered { color: var(--warning); font-weight: 600; background: #fffbeb; padding: 2px 6px; border-radius: 4px; }
        .badge-done { color: var(--success); font-weight: 600; background: #ecfdf5; padding: 2px 6px; border-radius: 4px; }
        
        /* æ“ä½œæŒ‰é’®åŒº */
        .book-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .book-card:hover .book-actions { opacity: 1; }
        
        /* --- è¯æ± æ¨¡å¼ --- */
        #pool-view { background: #f0f4f8; }
        .pool-container { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-wrap: wrap; gap: 10px; align-content: flex-start; justify-content: center; }
        
        .bubble {
            background: white; border: 1px solid #e2e8f0; border-radius: 20px;
            font-size: 14px; cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;
            min-width: 60px; max-width: 220px;
            display: inline-grid; grid-template-areas: "stack";
            align-items: center; justify-items: center;
        }
        
        .bubble-layer {
            grid-area: stack; padding: 8px 16px; text-align: center;
            width: max-content; max-width: 220px;
            transition: opacity 0.2s;
        }

        .bubble[data-state="word"] .layer-meaning { opacity: 0; visibility: hidden; }
        .bubble[data-state="word"] .layer-word { opacity: 1; visibility: visible; }

        .bubble[data-state="meaning"] { background: var(--primary-bg); border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .bubble[data-state="meaning"] .layer-word { opacity: 0; visibility: hidden; }
        .bubble[data-state="meaning"] .layer-meaning { opacity: 1; visibility: visible; }

        .bubble[data-state="mastered"] { background: var(--success); color: white; border-color: var(--success); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .bubble[data-state="mastered"] .layer-meaning { opacity: 0; visibility: hidden; }
        .bubble[data-state="mastered"] .layer-word { opacity: 1; visibility: visible; }

        .bubble.vanish { opacity: 0; pointer-events: none; cursor: default; }
        .bubble:hover:not(.vanish) { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: var(--primary); }

        /* --- æ‹–æ‹½é®ç½© --- */
        #drop-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(79, 70, 229, 0.95); z-index: 999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            color: white; backdrop-filter: blur(4px); pointer-events: none;
        }
        #drop-overlay.active { display: flex; pointer-events: auto; }

        /* --- è®­ç»ƒè§†å›¾ --- */
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--bg-body); display: flex; flex-direction: column; }
        .timer-bar { height: 4px; background: #e5e7eb; width: 100%; }
        .timer-progress { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        
        .training-container { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; }
        .layout-grid { display: grid; gap: 10px; width: 100%; height: 100%; transition: all 0.3s ease; }
        
        @media (max-width: 768px) {
            .layout-grid { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 160px; height: auto; padding-bottom: 80px; }
        }
        @media (min-width: 768px) {
            .training-container { justify-content: center; padding: 30px; }
            .layout-grid { grid-template-columns: repeat(var(--cols, 4), 1fr); grid-template-rows: repeat(2, 1fr); height: 100%; max-height: 85vh; }
            .word-card { height: 100% !important; }
        }
        
        .word-card { background: transparent; perspective: 1000px; height: 160px; cursor: pointer; position: relative; touch-action: manipulation; }
        .word-card.is-keyboard-focus .card-inner { box-shadow: 0 0 0 4px var(--focus-ring), 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.02); z-index: 10; }
        
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .word-card.is-reviewing .card-inner { transform: rotateY(180deg); }
        .word-card.is-mastered .card-inner { transform: rotateY(0deg); } 

        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: var(--radius); border: 2px solid #e5e7eb; background: white; overflow: hidden; display: flex; flex-direction: column; }
        .card-front { z-index: 2; background: white; color: var(--text-main); }
        .card-back { z-index: 1; transform: rotateY(180deg); background: #FFF1F2; border-color: #FECACA; }

        .section-top { height: 45%; width: 100%; display: flex; align-items: center; justify-content: center; padding: 0 10px; border-bottom: 1px dashed transparent; }
        .word-text { font-size: 22px; font-weight: 800; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

        .section-bottom { 
            height: 55%; width: 100%; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.01); 
            opacity: 0; transition: opacity 0.2s ease;
        }
        .word-card:hover .section-bottom, .word-card.is-keyboard-focus .section-bottom, .word-card.force-reveal .section-bottom { opacity: 1; }

        .card-back .section-top { border-bottom-color: #fca5a5; }
        .card-back .word-meaning { font-size: 15px; line-height: 1.4; color: #374151; font-weight: 500; }
        
        .word-card.is-mastered .card-front { border: 3px solid var(--success); background-color: #ecfdf5; }
        .check-mark { position: absolute; top: 8px; right: 8px; color: var(--success); font-size: 20px; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .word-card.is-mastered .check-mark { opacity: 1; transform: scale(1); }

        .pause-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 150; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(2px); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 90%; max-width: 450px; border-radius: 20px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay:not(.hidden) .modal { transform: scale(1); }
        .code-input { width: 100%; height: 120px; padding: 12px; background-color: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; resize: none; outline: none; margin: 10px 0; font-family: ui-monospace, monospace; font-size: 13px; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(17, 24, 39, 0.95); color: white; padding: 10px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; z-index: 999; pointer-events: none; opacity: 0; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; white-space: nowrap;}
    </style>
</head>
<body>

    <div id="drop-overlay">
        <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ“‚</div>
        <div style="font-size: 1.5rem; font-weight: 700;">é‡Šæ”¾å¯¼å…¥æ–‡ä»¶</div>
        <div style="opacity: 0.8; margin-top: 5px;">æ”¯æŒ backup.json (å«å­¦ä¹ è¿›åº¦)</div>
    </div>

    <div id="bookshelf-view" class="view">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h1>ğŸ§  è®°å¿†å¤§å¸ˆ</h1>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost" onclick="SyncSys.exportData()">ğŸ“¤ å¤‡ä»½è¿›åº¦</button>
                <button class="btn btn-outline" onclick="App.showImportModal()">+ å¯¼å…¥</button>
            </div>
        </header>
        
        <div style="max-width: 1000px; margin: 0 auto; width: 100%; padding-top: 10px;">
            <div class="toolbar">
                <select id="sort-pref" style="flex:1; min-width: 140px;">
                    <option value="unmastered">âš¡ æ’åºï¼šæœªæŒæ¡ä¼˜å…ˆ</option>
                    <option value="random">ğŸ² æ’åºï¼šéšæœºä¹±åº</option>
                    <option value="az">ğŸ”¤ æ’åºï¼šA-Z</option>
                </select>
                <button class="btn btn-ghost" onclick="App.toggleManageMode()" id="manage-btn">âš™ï¸ ç®¡ç†</button>
            </div>
            
            <div id="book-list" class="book-list"></div>
            
            <div style="text-align: center; margin-top: 30px; color: #9ca3af; font-size: 12px;">
                æç¤ºï¼šæ‹–æ‹½å•è¯æœ¬å¯åˆå¹¶ Â· æ‹–å…¥æ–‡ä»¶å¯è¿˜åŸå¤‡ä»½
            </div>
        </div>
    </div>

    <div id="training-view" class="full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="App.endTraining()">âœ• é€€å‡º</button>
            <div style="text-align: center;">
                <h1 id="train-book-title" style="font-size: 15px; margin:0;">è®­ç»ƒä¸­</h1>
                <span style="font-size: 11px; color: var(--text-sub)">è½®æ¬¡ <span id="round-count">1</span></span>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-ghost" onclick="Training.toggleAllMeanings()" title="æ˜¾ç¤ºæ‰€æœ‰é‡Šä¹‰">ğŸ‘ï¸</button>
                <button class="btn btn-ghost" id="pause-btn" onclick="Training.togglePause()" style="font-size: 18px;">â¸</button>
            </div>
        </header>
        
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        
        <div style="background: #FEF3C7; color: #D97706; padding: 6px; text-align: center; font-size: 12px;">
            ç©ºæ ¼/ç‚¹å‡»ç¿»è½¬ Â· æ‚¬åœ/å…¨å±€æŒ‰é’®çœ‹é‡Šä¹‰ Â· å›è½¦ç»“ç®—
        </div>

        <div id="card-container" class="training-container layout-grid"></div>
        
        <div style="padding: 12px; border-top: 1px solid #eee; background: white; display: flex; justify-content: center;">
             <button class="btn btn-outline" style="width: 100%; max-width: 300px; padding: 10px;" onclick="Training.finishBatch()">ğŸ“¥ æœ¬ç»„ç»“ç®— (Enter)</button>
        </div>

        <div id="pause-overlay" class="pause-overlay hidden">
            <div style="font-size: 40px; margin-bottom: 15px;">â¸</div>
            <button class="btn btn-primary" style="padding: 12px 30px;" onclick="Training.togglePause()">ç»§ç»­è®­ç»ƒ</button>
        </div>
    </div>

    <div id="pool-view" class="full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="Pool.close()">â¬… è¿”å›</button>
            <h1 style="font-size:16px;">ğŸŒŠ é€Ÿç­›è¯æ± </h1>
            <span style="width: 40px;"></span>
        </header>
        <div style="padding:10px; text-align:center; color:#666; font-size:12px; background:#fff; border-bottom:1px solid #eee;">
            è‡ªåŠ¨ä¹±åº Â· 5sè‡ªåŠ¨å›é€€(æœªæŒæ¡) Â· ç‚¹ä¸¤ä¸‹æŒæ¡(5séšèº«)
        </div>
        <div id="pool-container" class="pool-container"></div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 style="margin-top:0">å¯¼å…¥æ–°ä¹¦</h3>
            <input type="text" id="import-name-input" placeholder="å•è¯æœ¬åç§°" style="width:100%; padding:10px; border:2px solid #E5E7EB; border-radius:10px; outline:none; margin-bottom: 10px;">
            <textarea id="import-text" class="code-input" placeholder="ç²˜è´´å•è¯æ–‡æœ¬...&#10;apple è‹¹æœ&#10;banana é¦™è•‰"></textarea>
            <div style="display:flex; gap:10px; justify-content: flex-end;">
                <button class="btn btn-ghost" onclick="App.closeModals()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="App.processImport()">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <div id="toast">âœ… æ“ä½œæˆåŠŸ</div>

<script>
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    toast: (msg, type='success') => {
        const t = document.getElementById('toast');
        t.innerHTML = (type==='error'?'âŒ ':'âœ… ') + msg;
        t.style.opacity = 1; t.style.bottom = '40px';
        setTimeout(() => { t.style.opacity = 0; t.style.bottom = '30px'; }, 2000);
    }
};

const StorageManager = {
    getKey: (id) => id.startsWith('bk_') ? id : 'bk_' + id,
    save: (id, val) => { try { localStorage.setItem(StorageManager.getKey(id), JSON.stringify(val)); } catch(e) { Utils.toast('å­˜å‚¨å·²æ»¡', 'error'); } },
    get: (id) => { try { return JSON.parse(localStorage.getItem(StorageManager.getKey(id))); } catch(e) { return null; } },
    remove: (id) => localStorage.removeItem(StorageManager.getKey(id)),
    getAllBooks: () => {
        const books = [];
        for(let i=0; i<localStorage.length; i++) { 
            const k = localStorage.key(i); 
            if(k.startsWith('bk_')) { 
                try { 
                    const b = JSON.parse(localStorage.getItem(k)); 
                    if(b && b.words) books.push(b); 
                } catch(e) {} 
            } 
        }
        return books.sort((a,b) => b.isSystem ? 1 : (b.id > a.id ? -1 : 1));
    },
    updateWordStatus: (bookId, wordId, status) => {
        const book = StorageManager.get(bookId);
        if(!book) return;
        const w = book.words.find(x => x.id === wordId);
        if(w) { w.status = status; StorageManager.save(bookId, book); }
    }
};

const SyncSys = {
    exportData: () => {
        const data = {};
        for(let i=0; i<localStorage.length; i++) { 
            const k = localStorage.key(i); 
            if(k.startsWith('bk_')) data[k] = localStorage.getItem(k); 
        }
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `vocab_full_${new Date().toISOString().slice(0,10)}.json`; a.click();
        Utils.toast('å…¨é‡è¿›åº¦å·²å¤‡ä»½');
    },
    handleImportFile: (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (Array.isArray(json)) {
                    if(confirm("æ£€æµ‹åˆ°æ—§ç‰ˆæ ¼å¼ï¼Œæ˜¯å¦ä¿®å¤å¯¼å…¥ï¼Ÿ")) {
                        let count = 0;
                        json.forEach(oldBook => {
                            const newBook = {
                                id: oldBook.id || Utils.uuid(),
                                name: oldBook.name || "å¯¼å…¥æœ¬",
                                isSystem: false,
                                words: (oldBook.words || []).map(w => ({
                                    word: w.word || w.spelling,
                                    meaning: w.meaning,
                                    status: (w.status === 2 || w.mastered) ? 2 : 0, 
                                    id: Utils.uuid()
                                }))
                            };
                            StorageManager.save(newBook.id, newBook);
                            count++;
                        });
                        Utils.toast(`å¯¼å…¥ ${count} æœ¬ä¹¦`);
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    if(confirm("æ¢å¤å¤‡ä»½å°†è¦†ç›–åŒåæ•°æ®ï¼Œç»§ç»­ï¼Ÿ")) {
                        let count = 0;
                        for(const k in json) { if(k.startsWith('bk_')) { localStorage.setItem(k, json[k]); count++; } }
                        Utils.toast(`æ¢å¤ ${count} é¡¹æ•°æ®`);
                        setTimeout(() => location.reload(), 1000);
                    }
                }
            } catch(err) { alert("æ–‡ä»¶æ— æ•ˆ"); }
        };
        reader.readAsText(file);
    }
};

const Pool = {
    currentBookId: null,
    start: (bookId) => {
        Pool.currentBookId = bookId;
        const book = StorageManager.get(bookId);
        if(!book) return;
        
        const words = book.words.filter(w => w.status !== 2);
        if(words.length === 0) { Utils.toast("æœ¬ä¹¦å·²å…¨éƒ¨æŒæ¡ï¼"); return; }

        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('pool-view').classList.remove('hidden');
        
        const container = document.getElementById('pool-container');
        container.innerHTML = '';
        
        // æ ¸å¿ƒåŠŸèƒ½ï¼šå¼ºåˆ¶ä¹±åº
        words.sort(() => 0.5 - Math.random());

        words.forEach(w => {
            const el = document.createElement('div');
            el.className = 'bubble';
            el.dataset.state = 'word'; 
            
            // Grid Stack å®ç°å°ºå¯¸ç¨³å®š
            el.innerHTML = `
                <div class="bubble-layer layer-word">${w.word}</div>
                <div class="bubble-layer layer-meaning">${w.meaning}</div>
            `;
            
            el.onclick = () => {
                if (el.actionTimer) clearTimeout(el.actionTimer);

                // 1. å·²æŒæ¡ -> æ’¤é”€
                if (el.classList.contains('mastered')) {
                    el.classList.remove('mastered', 'vanish');
                    el.dataset.state = 'word';
                    StorageManager.updateWordStatus(Pool.currentBookId, w.id, 0); 
                    return;
                }

                // 2. å•è¯ -> é‡Šä¹‰ + è‡ªåŠ¨å›é€€
                if (el.dataset.state === 'word') {
                    el.dataset.state = 'meaning';
                    el.actionTimer = setTimeout(() => {
                        if (el.dataset.state === 'meaning') {
                            el.dataset.state = 'word';
                        }
                    }, 5000);
                    return;
                }

                // 3. é‡Šä¹‰ -> æŒæ¡ + è‡ªåŠ¨éšèº«
                if (el.dataset.state === 'meaning') {
                    el.dataset.state = 'mastered';
                    el.classList.add('mastered');
                    StorageManager.updateWordStatus(Pool.currentBookId, w.id, 2); 
                    el.actionTimer = setTimeout(() => { el.classList.add('vanish'); }, 5000);
                }
            };
            container.appendChild(el);
        });
    },
    close: () => {
        document.getElementById('pool-view').classList.add('hidden');
        document.getElementById('bookshelf-view').classList.remove('hidden');
        App.renderList(); 
    }
};

const Training = {
    queue: [], current: [], timer: null, round: 0, 
    hasInteracted: false, isPaused: false, timeLeft: 60, focusIndex: -1,
    globalReveal: false,
    
    start: (bookId) => {
        const book = StorageManager.get(bookId);
        if(!book || !book.words.length) { Utils.toast('ç©ºå•è¯æœ¬', 'error'); return; }
        
        const sortType = document.getElementById('sort-pref').value;
        let words = [...book.words];
        if (sortType === 'random') words.sort(() => 0.5 - Math.random());
        else if (sortType === 'az') words.sort((a,b) => a.word.localeCompare(b.word));
        else if (sortType === 'unmastered') words.sort((a,b) => (a.status===2 ? 1 : 0) - (b.status===2 ? 1 : 0));

        Training.queue = words;
        Training.round = 0;
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('training-view').classList.remove('hidden');
        document.getElementById('train-book-title').innerText = book.name;
        window.addEventListener('keydown', Training.handleKeyDown);
        Training.next();
    },
    next: () => {
        clearInterval(Training.timer);
        Training.round++;
        document.getElementById('round-count').innerText = Training.round;
        const batch = Training.queue.splice(0, 8);
        if(!batch.length) { alert('ğŸ‰ æœ¬è½®å®Œæˆï¼'); App.endTraining(); return; }
        
        Training.current = batch.map(w => ({...w, status: 0})); 
        Training.hasInteracted = false; Training.focusIndex = -1; Training.timeLeft = 60; Training.isPaused = false;
        Training.render(); Training.startTimer();
        Training.setFocus(0, true);
    },
    startTimer: () => {
        clearInterval(Training.timer);
        const bar = document.getElementById('timer-progress');
        bar.style.transition = 'none'; bar.style.width = (Training.timeLeft/60)*100 + '%'; bar.offsetHeight; bar.style.transition = 'width 1s linear';
        Training.timer = setInterval(() => {
            if(Training.isPaused) return; 
            Training.timeLeft--;
            bar.style.width = (Training.timeLeft/60)*100+'%'; 
            if(Training.timeLeft<=0) Training.finishBatch(); 
        }, 1000);
    },
    togglePause: () => {
        Training.isPaused = !Training.isPaused;
        const overlay = document.getElementById('pause-overlay');
        const btn = document.getElementById('pause-btn');
        if(Training.isPaused) {
            overlay.classList.remove('hidden'); btn.innerText = "â–¶ï¸";
            document.getElementById('timer-progress').style.transition = 'none';
        } else {
            overlay.classList.add('hidden'); btn.innerText = "â¸";
            document.getElementById('timer-progress').style.transition = 'width 1s linear';
        }
    },
    toggleAllMeanings: () => {
        Training.globalReveal = !Training.globalReveal;
        document.querySelectorAll('.word-card').forEach(el => {
            if(Training.globalReveal) el.classList.add('force-reveal');
            else el.classList.remove('force-reveal');
        });
    },
    finishBatch: () => {
        if (!Training.hasInteracted && Training.timeLeft <= 0) { App.endTraining(); return; }
        const notMastered = Training.current.filter(w => w.status !== 2);
        if(notMastered.length) { 
            const mb = StorageManager.get('system_mistakes');
            notMastered.forEach(w => { 
                if(!mb.words.find(x=>x.word===w.word)) mb.words.unshift({...w, id:Utils.uuid(), status:0}); 
            });
            StorageManager.save('system_mistakes', mb);
            Training.queue.push(...notMastered); 
            Utils.toast(`${notMastered.length} ä¸ªæœªæŒæ¡`); 
        } else { Utils.toast('å…¨å¯¹ï¼'); }
        Training.next();
    },
    handleCardClick: (id, event) => {
        if(Training.isPaused) return;
        Training.hasInteracted = true;
        const index = Training.current.findIndex(x => x.id === id);
        if(index === -1) return;
        const w = Training.current[index];
        const el = document.getElementById('card-' + id);
        
        Training.setFocus(index, false); 

        if (w.status === 2) { w.status = 1; el.classList.remove('is-mastered'); el.classList.add('is-reviewing'); }
        else if (w.status === 1) { w.status = 2; el.classList.remove('is-reviewing'); el.classList.add('is-mastered'); }
        else { w.status = 1; el.classList.add('is-reviewing'); }
        
        if(Training.current.every(x => x.status === 2)) setTimeout(Training.finishBatch, 500);
    },
    setFocus: (index, isKeyboard = false) => {
        if (index < 0 || index >= Training.current.length) return;
        if(Training.focusIndex !== -1) { 
            const oldEl = document.getElementById('card-' + Training.current[Training.focusIndex].id); 
            if(oldEl) oldEl.classList.remove('is-keyboard-focus'); 
        }
        Training.focusIndex = index;
        if (isKeyboard) {
            const newEl = document.getElementById('card-' + Training.current[Training.focusIndex].id);
            if(newEl) { newEl.classList.add('is-keyboard-focus'); newEl.scrollIntoView({behavior: "smooth", block: "center"}); }
        }
    },
    handleKeyDown: (e) => {
        if(document.getElementById('training-view').classList.contains('hidden')) return;
        if(Training.isPaused && e.code !== 'KeyP') return;
        
        const isUp = e.code === 'KeyW' || e.code === 'ArrowUp';
        const isDown = e.code === 'KeyS' || e.code === 'ArrowDown';
        const isLeft = e.code === 'KeyA' || e.code === 'ArrowLeft';
        const isRight = e.code === 'KeyD' || e.code === 'ArrowRight';
        const isFlip = e.code === 'Space';
        const isEnter = e.code === 'Enter';
        
        if (e.code === 'KeyP') { Training.togglePause(); return; }
        if (isEnter) { Training.finishBatch(); return; }
        
        let cols = 2; 
        if (window.innerWidth >= 768) cols = Math.ceil(Training.current.length / 2);

        let nextIndex = Training.focusIndex;
        if (nextIndex === -1 && (isUp||isDown||isLeft||isRight)) { Training.setFocus(0, true); return; }

        if (isRight) { if ((nextIndex + 1) % cols !== 0) nextIndex++; } 
        else if (isLeft) { if (nextIndex % cols !== 0) nextIndex--; } 
        else if (isDown) { if (nextIndex + cols < Training.current.length) nextIndex += cols; } 
        else if (isUp) { if (nextIndex - cols >= 0) nextIndex -= cols; } 
        else if (isFlip) { 
            e.preventDefault(); 
            if (nextIndex !== -1) Training.handleCardClick(Training.current[nextIndex].id);
            Training.setFocus(nextIndex, true);
        }
        
        if (nextIndex !== Training.focusIndex && nextIndex < Training.current.length) Training.setFocus(nextIndex, true); 
    },
    render: () => {
        const c = document.getElementById('card-container'); c.innerHTML='';
        c.style.setProperty('--cols', Math.ceil(Training.current.length / 2));
        Training.current.forEach(w => {
            const el = document.createElement('div'); el.className='word-card'; el.id='card-'+w.id;
            if(w.status === 1) el.classList.add('is-reviewing');
            if(w.status === 2) el.classList.add('is-mastered');
            if(Training.globalReveal) el.classList.add('force-reveal');
            
            el.onclick = (e) => Training.handleCardClick(w.id, e);
            
            el.innerHTML = `
                <div class="card-inner">
                    <div class="card-front">
                        <div class="check-mark">âœ…</div>
                        <div class="section-top"><div class="word-text" title="${w.word}">${w.word}</div></div>
                        <div class="section-bottom"></div>
                    </div>
                    <div class="card-back">
                        <div class="section-top"><div class="word-text">${w.word}</div></div>
                        <div class="section-bottom">
                            <div class="word-meaning">${w.meaning}</div>
                        </div>
                    </div>
                </div>`;
            c.appendChild(el);
        });
    }
};

const App = {
    isManageMode: false,
    init: () => { 
        if(!StorageManager.get('system_mistakes')) StorageManager.save('system_mistakes', {id:'system_mistakes', name:'ğŸ“… é”™é¢˜æœ¬', words:[], isSystem:true}); 
        App.renderList(); 
        App.setupGlobalDragDrop();
    },
    toggleManageMode: () => { 
        App.isManageMode = !App.isManageMode; 
        document.getElementById('manage-btn').innerText = App.isManageMode ? 'å®Œæˆ' : 'âš™ï¸ ç®¡ç†'; 
        document.getElementById('manage-btn').style.color = App.isManageMode ? 'var(--primary)' : 'var(--text-sub)'; 
        App.renderList(); 
    },
    handleDeleteBook: (bookId, event) => { 
        event.stopPropagation(); 
        if(confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) { StorageManager.remove(bookId); App.renderList(); } 
    },
    handleExportBook: (bookId, event) => {
        event.stopPropagation();
        const book = StorageManager.get(bookId);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(book)], {type:'application/json'})); a.download = `${book.name}.json`; a.click();
    },
    // æ–°å¢ï¼šæ‰‹åŠ¨å»é‡
    handleDedupeBook: (bookId, event) => {
        event.stopPropagation();
        const book = StorageManager.get(bookId);
        if (!book) return;
        const uniqueMap = new Map();
        const originalCount = book.words.length;
        
        book.words.forEach(w => {
            if (!uniqueMap.has(w.word)) {
                uniqueMap.set(w.word, w);
            } else {
                // ä¿ç•™çŠ¶æ€æ›´å¥½çš„é‚£ä¸ª (å·²æŒæ¡ > æœªæŒæ¡)
                const exist = uniqueMap.get(w.word);
                if (w.status > exist.status) uniqueMap.set(w.word, w);
            }
        });
        
        const newWords = Array.from(uniqueMap.values());
        const removed = originalCount - newWords.length;
        
        if (removed > 0) {
            if(confirm(`å‘ç° ${removed} ä¸ªé‡å¤é¡¹ï¼Œç¡®å®šæ¸…ç†ï¼Ÿ`)) {
                book.words = newWords;
                StorageManager.save(bookId, book);
                App.renderList();
                Utils.toast(`æ¸…ç†äº† ${removed} ä¸ªé‡å¤è¯`);
            }
        } else {
            Utils.toast("æ²¡æœ‰å‘ç°é‡å¤è¯");
        }
    },
    handlePoolMode: (bookId, event) => {
        event.stopPropagation();
        Pool.start(bookId);
    },
    renderList: () => {
        const list = document.getElementById('book-list'); list.innerHTML = '';
        const books = StorageManager.getAllBooks();
        
        books.forEach(b => {
            const el = document.createElement('div'); el.className = 'book-card';
            el.draggable = true;
            
            const total = b.words.length;
            const mastered = b.words.filter(w => w.status === 2).length;
            const remaining = total - mastered;

            el.ondragstart = (e) => { e.dataTransfer.setData('sourceId', b.id); };
            el.ondragover = (e) => { e.preventDefault(); el.classList.add('drag-over'); };
            el.ondragleave = () => { el.classList.remove('drag-over'); };
            el.ondrop = (e) => {
                e.preventDefault(); el.classList.remove('drag-over');
                const srcId = e.dataTransfer.getData('sourceId');
                if(srcId && srcId !== b.id) App.mergeBooks(srcId, b.id);
            };

            el.onclick = () => { if(!App.isManageMode) Training.start(b.id); };
            
            el.innerHTML = `
                <div class="book-info">
                    <div class="book-title">${b.name}</div>
                    <div class="book-meta">
                        ${remaining > 0 ? `<span class="badge-unmastered">å¾…å­¦ ${remaining}</span>` : `<span class="badge-done">å·²å®Œæˆ</span>`}
                        <span>/ æ€» ${total}</span>
                        ${b.isSystem ? '<span>(ç³»ç»Ÿ)</span>' : ''}
                    </div>
                </div>
                <div class="book-actions" style="${App.isManageMode ? 'opacity:1' : ''}">
                    <button class="btn btn-ghost" title="æ°”æ³¡ç­›é€‰" onclick="App.handlePoolMode('${b.id}', event)">ğŸŒŠ</button>
                    <button class="btn btn-ghost" title="å»é‡" onclick="App.handleDedupeBook('${b.id}', event)">ğŸ§¹</button>
                    <button class="btn btn-ghost" title="å¯¼å‡º" onclick="App.handleExportBook('${b.id}', event)">ğŸ“¥</button>
                    ${!b.isSystem ? `<button class="btn btn-ghost" style="color:var(--danger)" title="åˆ é™¤" onclick="App.handleDeleteBook('${b.id}', event)">ğŸ—‘</button>` : ''}
                </div>
            `;
            list.appendChild(el);
        });
        if(books.length === 0) list.innerHTML = '<div style="text-align:center;color:#999;padding:40px; grid-column: 1/-1;">ä¹¦æ¶æ˜¯ç©ºçš„</div>';
    },
    mergeBooks: (srcId, targetId) => {
        const src = StorageManager.get(srcId);
        const tgt = StorageManager.get(targetId);
        if(confirm(`åˆå¹¶ "${src.name}" åˆ° "${tgt.name}"ï¼Ÿ`)) {
            const existWords = new Set(tgt.words.map(w => w.word));
            let count = 0;
            src.words.forEach(w => {
                if(!existWords.has(w.word)) { tgt.words.push(w); count++; }
            });
            StorageManager.save(targetId, tgt);
            StorageManager.remove(srcId);
            App.renderList();
            Utils.toast(`åˆå¹¶æˆåŠŸï¼Œæ–°å¢ ${count} è¯`);
        }
    },
    setupGlobalDragDrop: () => {
        const overlay = document.getElementById('drop-overlay');
        document.body.ondragenter = (e) => { if(e.dataTransfer.types.includes('Files')) overlay.classList.add('active'); };
        overlay.ondragleave = (e) => { if(e.target === overlay) overlay.classList.remove('active'); };
        document.body.ondragover = (e) => e.preventDefault();
        document.body.ondrop = (e) => {
            e.preventDefault(); overlay.classList.remove('active');
            if(e.dataTransfer.files[0]) SyncSys.handleImportFile(e.dataTransfer.files[0]);
        };
    },
    processImport: () => {
        const text = document.getElementById('import-text').value;
        const name = document.getElementById('import-name-input').value;
        if(!text) return;
        const words = [];
        text.split('\n').forEach(line => {
            line = line.trim(); if(!line) return;
            const match = line.match(/^([^\s]+)\s+(?:(\/[^\/]+\/)\s+)?(.+)$/);
            if(match) words.push({word: match[1], meaning: match[3], status: 0, id: Utils.uuid()});
            else { const parts = line.split(/\s+/); if(parts.length>1) words.push({word: parts[0], meaning: parts.slice(1).join(' '), status: 0, id: Utils.uuid()}); }
        });
        StorageManager.save(Utils.uuid(), { id: Utils.uuid(), name: name || 'å¯¼å…¥ '+new Date().toLocaleDateString(), words: words, isSystem: false });
        App.closeModals(); App.renderList(); Utils.toast(`å¯¼å…¥ ${words.length} è¯`);
    },
    showImportModal: () => { document.getElementById('import-modal').classList.remove('hidden'); },
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.add('hidden')),
    endTraining: () => { clearInterval(Training.timer); window.removeEventListener('keydown', Training.handleKeyDown); document.getElementById('training-view').classList.add('hidden'); document.getElementById('bookshelf-view').classList.remove('hidden'); App.renderList(); }
};

window.onload = App.init;
</script>
</body>
</html>
