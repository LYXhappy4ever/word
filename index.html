<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•è¯è®­ç»ƒå™¨ (å®Œç¾ä¿®å¤ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-bg: #EEF2FF;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --success: #10B981;
            --focus-ring: #818cf8;
            --radius: 16px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        html { box-sizing: border-box; -webkit-tap-highlight-color: transparent; scrollbar-gutter: stable; }
        body { margin: 0; padding: 0; font-family: var(--font-stack); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        * { box-sizing: border-box; }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        .btn { border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; outline: none; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: #4338ca; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
        .btn-outline { border: 1px solid #E5E7EB; background: white; color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        
        .hidden { display: none !important; }
        .view { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; z-index: 50; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }

        /* ä¹¦æ¶åˆ—è¡¨ */
        #bookshelf-view { overflow-y: auto; padding: 20px; }
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; padding-bottom: 40px; }
        
        .book-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            height: 90px; position: relative; overflow: hidden; transition: all 0.2s; cursor: pointer;
        }
        .book-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .book-info { flex: 1; pointer-events: none; }
        .book-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #111827; }
        .book-meta { font-size: 13px; color: #9CA3AF; }
        .book-arrow { font-size: 20px; color: #E5E7EB; margin-left: 10px; }

        /* ç®¡ç†æ¨¡å¼é®ç½© */
        .manage-actions {
            display: none; position: absolute; inset: 0; 
            background: rgba(255, 255, 255, 0.95); 
            z-index: 10; align-items: center; justify-content: center; gap: 10px;
        }
        body.manage-mode .manage-actions { display: flex; animation: fadeIn 0.2s; }
        body.manage-mode .book-card { transform: none !important; cursor: default; }

        /* è®­ç»ƒç•Œé¢ */
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--bg-body); display: flex; flex-direction: column; }
        .timer-bar { height: 4px; background: #e5e7eb; width: 100%; }
        .timer-progress { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        .training-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        
        /* --- æ ¸å¿ƒå¸ƒå±€ä¿®æ”¹ --- */
        .layout-grid { 
            display: grid; 
            gap: 15px; 
            width: 100%;
            height: 100%;
            transition: all 0.3s ease; 
        }

        /* ç§»åŠ¨ç«¯ï¼šåŒåˆ—æµå¼å¸ƒå±€ï¼Œæ€ä¹ˆèˆ’æœæ€ä¹ˆæ¥ */
        @media (max-width: 768px) {
            .layout-grid {
                grid-template-columns: repeat(2, 1fr);
                /* é«˜åº¦è‡ªé€‚åº”å†…å®¹ï¼Œä¸å¼ºåˆ¶å¡«æ»¡å±å¹•ï¼Œå…è®¸æ»šåŠ¨ */
                grid-auto-rows: 160px; 
                height: auto; 
            }
        }

        /* ç”µè„‘/å¹³æ¿ï¼šå¼ºåˆ¶åŒè¡Œï¼Œåˆ—æ•°åŠ¨æ€è®¡ç®— */
        @media (min-width: 768px) {
            .training-container { justify-content: center; padding: 40px; }
            .layout-grid {
                /* --cols å˜é‡ç”± JS è®¡ç®— (å•è¯æ•°/2) */
                grid-template-columns: repeat(var(--cols, 4), 1fr);
                grid-template-rows: repeat(2, 1fr); /* å¼ºåˆ¶ä¸¤è¡Œ */
                height: 100%;
                max-height: 85vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢å¡ç‰‡å¤ªå¤§ */
            }
            .word-card { height: 100% !important; }
        }
        
        /* å¡ç‰‡ç»„ä»¶ */
        .word-card { background: transparent; perspective: 1000px; height: 160px; cursor: pointer; position: relative; touch-action: manipulation; }
        /* é”®ç›˜é€‰ä¸­æ•ˆæœ */
        .word-card.is-keyboard-focus .card-inner { box-shadow: 0 0 0 4px var(--focus-ring), 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.02); z-index: 10; }
        
        .card-inner { 
            position: relative; width: 100%; height: 100%; text-align: center; 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            transform-style: preserve-3d; border-radius: var(--radius); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        }
        
        /* ç¿»è½¬é€»è¾‘ */
        .word-card.is-reviewing .card-inner { transform: rotateY(180deg); }
        .word-card.is-mastered .card-inner { transform: rotateY(0deg); } 

        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: var(--radius); border: 2px solid #e5e7eb; background: white; overflow: hidden; display: flex; flex-direction: column; }
        .card-front { z-index: 2; background: white; color: var(--text-main); }
        .card-back { z-index: 1; transform: rotateY(180deg); background: #FFF1F2; border-color: #FECACA; }

        /* å†…å®¹å¸ƒå±€ */
        .section-top { 
            height: 45%; width: 100%; 
            display: flex; align-items: center; justify-content: center; 
            padding: 0 10px; 
            border-bottom: 1px dashed transparent;
        }
        
        /* å•è¯æ–‡æœ¬ä¼˜åŒ–ï¼šä¸æ¢è¡Œï¼Œè‡ªåŠ¨è°ƒæ•´ */
        .word-text { 
            font-size: 26px; /* åˆå§‹å¤§å­—å· */
            font-weight: 800; 
            color: var(--text-main); 
            white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
            line-height: 1;
            padding: 0 5px;
            /* é…åˆJSè‡ªåŠ¨ç¼©å° */
        }

        .section-bottom { height: 55%; width: 100%; padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; overflow-y: auto; background: rgba(0,0,0,0.01); }
        .card-back .section-top { border-bottom-color: #FECACA; }
        .card-back .word-meaning { font-size: 15px; line-height: 1.6; color: #4B5563; }
        
        /* å·²æŒæ¡æ ·å¼ */
        .word-card.is-mastered .card-front { border: 3px solid var(--success); background-color: #ECFDF5; }
        .check-mark { position: absolute; top: 10px; right: 10px; color: var(--success); font-size: 24px; opacity: 0; transform: scale(0.5); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .word-card.is-mastered .check-mark { opacity: 1; transform: scale(1); }

        .pause-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); z-index: 150; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* å¼¹çª—æ ·å¼ä¼˜åŒ– */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 90%; max-width: 420px; border-radius: 20px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay:not(.hidden) .modal { transform: scale(1); }

        /* ç¾åŒ–æ–‡æœ¬æ¡† (ä¼˜åŒ–ç‚¹) */
        .code-input {
            width: 100%; height: 120px; 
            padding: 12px;
            background-color: #1e293b; /* æ·±è‰²èƒŒæ™¯ */
            color: #e2e8f0; /* æµ…è‰²æ–‡å­— */
            font-family: var(--font-mono);
            font-size: 13px;
            border: 2px solid #334155;
            border-radius: 10px;
            resize: none; outline: none;
            margin: 10px 0;
            transition: border-color 0.2s;
        }
        .code-input:focus { border-color: var(--primary); }
        .code-input::placeholder { color: #64748b; }

        .key-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .key-badge { background: white; padding: 6px 10px; border-radius: 6px; font-family: var(--font-mono); font-size: 13px; font-weight: bold; border: 1px solid #d1d5db; cursor: pointer; min-width: 70px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .key-badge.recording { background: var(--primary); color: white; border-color: var(--primary); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(17, 24, 39, 0.95); color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; font-weight: 500; z-index: 999; pointer-events: none; opacity: 0; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="bookshelf-view" class="view">
        <header>
            <button class="btn btn-ghost" onclick="App.toggleManageMode()" id="manage-btn">âš™ï¸ ç®¡ç†</button>
            <h1>å•è¯è®­ç»ƒå™¨</h1>
            <div style="display: flex; gap: 6px;">
                <button class="btn btn-ghost" onclick="Settings.show()" title="é”®ä½">âŒ¨ï¸</button>
                <button class="btn btn-ghost" onclick="App.showSyncModal()" title="åŒæ­¥">â˜ï¸</button>
                <button class="btn btn-primary" onclick="App.showImportModal()">+ å¯¼å…¥</button>
            </div>
        </header>
        <div id="book-list" class="book-list"></div>
    </div>

    <div id="training-view" class="full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="App.endTraining()">âœ• é€€å‡º</button>
            <div style="text-align: center;">
                <h1 id="train-book-title" style="font-size: 16px; margin:0;">è®­ç»ƒä¸­</h1>
                <span style="font-size: 12px; color: var(--text-sub)">è½®æ¬¡ <span id="round-count">1</span></span>
            </div>
            <button class="btn btn-ghost" id="pause-btn" onclick="Training.togglePause()" style="font-size: 18px;">â¸</button>
        </header>
        
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        
        <div style="background: #FEF3C7; color: #D97706; padding: 8px; text-align: center; font-size: 12px; border-bottom: 1px solid #FDE68A;">
            æŒ‰ <span id="hint-move" style="font-family:var(--font-mono); font-weight:bold;">WASD</span> ç§»åŠ¨ Â· <span id="hint-flip" style="font-family:var(--font-mono); font-weight:bold;">Space</span> ç¿»è½¬
        </div>

        <div id="card-container" class="training-container layout-grid"></div>
        
        <div style="padding: 16px; border-top: 1px solid #eee; background: white; text-align: center;">
             <button class="btn btn-outline" style="width: 100%" id="finish-btn" onclick="Training.finishBatch()">æå‰ç»“ç®—</button>
        </div>

        <div id="pause-overlay" class="pause-overlay hidden">
            <div style="font-size: 40px; margin-bottom: 15px;">â¸</div>
            <h2 style="color: var(--text-main); margin-top: 0;">è®­ç»ƒå·²æš‚åœ</h2>
            <button class="btn btn-primary" style="margin-top: 10px; padding: 12px 30px;" onclick="Training.togglePause()">ç»§ç»­è®­ç»ƒ</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 style="margin-top:0">âŒ¨ï¸ æŒ‰é”®è®¾ç½®</h3>
            <div id="keys-list" style="max-height: 300px; overflow-y: auto;"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-outline" style="flex:1" onclick="Settings.reset()">æ¢å¤é»˜è®¤</button>
                <button class="btn btn-primary" style="flex:1" onclick="App.closeModals()">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 style="margin-top:0">å¯¼å…¥æ–°ä¹¦</h3>
            <input type="file" id="import-file" class="hidden" accept=".json,.txt" onchange="App.handleFileSelect(this)">
            <button class="btn btn-outline" style="width:100%; border-style:dashed;" onclick="document.getElementById('import-file').click()">ğŸ“‚ é€‰æ‹©æ–‡ä»¶ (TXT)</button>
            
            <textarea id="import-text" class="code-input" placeholder="æˆ–è€…ç›´æ¥ç²˜è´´æ–‡æœ¬...&#10;æ ¼å¼ç¤ºä¾‹ï¼š&#10;apple è‹¹æœ&#10;banana é¦™è•‰"></textarea>
            
            <input type="text" id="import-name-input" placeholder="ä¹¦å (å¯é€‰)" style="width:100%; padding:10px; border:2px solid #E5E7EB; border-radius:10px; margin-bottom:15px; outline:none; transition:0.2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#E5E7EB'">
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-ghost" style="flex:1" onclick="App.closeModals()">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex:1" onclick="App.processImport()">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 style="margin-top:0">æ•°æ®å¤‡ä»½ & æ¢å¤</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-outline" style="flex:1" onclick="SyncSys.exportData()">ğŸ“‹ å¤åˆ¶æ•°æ®ç </button>
                <button class="btn btn-outline" style="flex:1" onclick="SyncSys.downloadFile()">ğŸ’¾ ä¸‹è½½å¤‡ä»½</button>
            </div>
            
            <div style="border-top: 1px solid #eee; margin: 15px 0;"></div>
            <h3 style="margin-top:10px; font-size:16px;">æ¢å¤æ•°æ®</h3>
            
            <button class="btn btn-outline" style="width:100%; border-style:dashed; margin-bottom: 10px;" onclick="document.getElementById('sync-file-input').click()">ğŸ“‚ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶ (.JSON)</button>
            <input type="file" id="sync-file-input" class="hidden" accept=".json" onchange="SyncSys.handleFile(this)">
            
            <textarea id="sync-text" class="code-input" placeholder="ç²˜è´´æ•°æ®ç ä»¥æ¢å¤..."></textarea>
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-ghost" style="flex:1" onclick="App.closeModals()">å…³é—­</button>
                <button class="btn btn-primary" style="flex:1" onclick="SyncSys.executeImport()">ğŸ”„ ç«‹å³æ¢å¤</button>
            </div>
        </div>
    </div>

    <div id="toast">âœ… æ“ä½œæˆåŠŸ</div>

<script>
// --- å·¥å…·ç±» ---
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    toast: (msg, type='success') => {
        const t = document.getElementById('toast');
        t.innerHTML = (type==='error'?'âŒ ':'âœ… ') + msg;
        t.style.opacity = 1; t.style.top = '20px';
        setTimeout(() => { t.style.opacity = 0; t.style.top = '-50px'; }, 2500);
    },
    // å¢å¼ºç‰ˆè§£æå™¨ï¼Œå…¼å®¹å¤šç§åˆ†éš”ç¬¦
    parseWords: (text) => {
        const words = [];
        try {
            // å°è¯•ä½œä¸ºJSONè§£æ
            const json = JSON.parse(text);
            const list = Array.isArray(json) ? json : (json.fullContent || []);
            list.forEach(w => { if(w.word && w.meaning) words.push({...w, id: Utils.uuid()}) });
            if(words.length > 0) return words;
        } catch(e) {}
        
        // æ–‡æœ¬è§£æ
        text.split('\n').forEach(line => {
            line = line.trim();
            if(!line) return;
            // åŒ¹é…ç¬¬ä¸€ä¸ª ç©ºæ ¼/Tab/å†’å· ä½œä¸ºåˆ†éš”ç¬¦
            const match = line.match(/^([^\s:ï¼š]+)[\s:ï¼š]+(.*)/); 
            if(match) {
                words.push({word: match[1], meaning: match[2], id: Utils.uuid()});
            } else {
                // å…¼å®¹æ²¡æœ‰åˆ†éš”ç¬¦çš„æƒ…å†µï¼Œå½“åšåªæœ‰å•è¯
                words.push({word: line, meaning: '...', id: Utils.uuid()});
            }
        });
        return words;
    }
};

// --- æŒ‰é”®ç®¡ç† (ä¿®å¤äº†å®ŒæˆæŒ‰é’®ä¸å…³é—­çš„é—®é¢˜) ---
const Settings = {
    defaults: { up: 'KeyW', down: 'KeyS', left: 'KeyA', right: 'KeyD', flip: 'Space', pause: 'KeyP', finish: 'Enter' },
    keys: {},
    labels: { up: 'â¬†ï¸ ä¸Šç§»', down: 'â¬‡ï¸ ä¸‹ç§»', left: 'â¬…ï¸ å·¦ç§»', right: 'â¡ï¸ å³ç§»', flip: 'ğŸ”„ ç¿»è½¬', pause: 'â¸ æš‚åœ', finish: 'ğŸ ç»“ç®—' },
    init: () => {
        const stored = localStorage.getItem('app_key_config');
        Settings.keys = stored ? JSON.parse(stored) : {...Settings.defaults};
        Settings.updateHints();
    },
    save: () => { localStorage.setItem('app_key_config', JSON.stringify(Settings.keys)); Settings.updateHints(); },
    reset: () => { Settings.keys = {...Settings.defaults}; Settings.save(); Settings.render(); Utils.toast('å·²æ¢å¤é»˜è®¤'); },
    updateHints: () => {
        const fmt = (k) => k.replace('Key', '').replace('Digit', '');
        if(document.getElementById('hint-move')) document.getElementById('hint-move').innerText = fmt(Settings.keys.up)+fmt(Settings.keys.left)+fmt(Settings.keys.down)+fmt(Settings.keys.right);
        if(document.getElementById('hint-flip')) document.getElementById('hint-flip').innerText = fmt(Settings.keys.flip);
        document.getElementById('pause-btn').title = `æš‚åœ (${fmt(Settings.keys.pause)})`;
        document.getElementById('finish-btn').innerText = `æå‰ç»“ç®— (${fmt(Settings.keys.finish)})`;
    },
    show: () => { document.getElementById('settings-modal').classList.remove('hidden'); Settings.render(); },
    render: () => {
        const list = document.getElementById('keys-list'); list.innerHTML = '';
        for (const [action, code] of Object.entries(Settings.keys)) {
            const row = document.createElement('div'); row.className = 'key-row';
            row.innerHTML = `<span>${Settings.labels[action]}</span><div class="key-badge" onclick="Settings.bind('${action}', this)">${code}</div>`;
            list.appendChild(row);
        }
    },
    bind: (action, btnEl) => {
        btnEl.innerText = 'æŒ‰ä¸‹...'; btnEl.classList.add('recording');
        const handler = (e) => { 
            e.preventDefault(); e.stopPropagation(); 
            Settings.keys[action] = e.code; 
            Settings.save(); Settings.render(); 
            window.removeEventListener('keydown', handler); 
        };
        window.addEventListener('keydown', handler, {once: true});
    }
};

const StorageManager = {
    getKey: (id) => id.startsWith('bk_') ? id : 'bk_' + id,
    save: (id, val) => { try { localStorage.setItem(StorageManager.getKey(id), JSON.stringify(val)); } catch(e) { Utils.toast('å­˜å‚¨ç©ºé—´å·²æ»¡', 'error'); } },
    get: (id) => { try { return JSON.parse(localStorage.getItem(StorageManager.getKey(id))); } catch(e) { return null; } },
    remove: (id) => localStorage.removeItem(StorageManager.getKey(id)),
    getAllBooks: () => {
        const books = [];
        for(let i=0; i<localStorage.length; i++) { const k = localStorage.key(i); if(k.startsWith('bk_')) { try { const b = JSON.parse(localStorage.getItem(k)); if(b && b.words) books.push(b); } catch(e) {} } }
        return books.sort((a,b) => b.isSystem ? 1 : -1);
    }
};

const SyncSys = {
    exportData: () => {
        const data = {};
        for(let i=0; i<localStorage.length; i++) { const k = localStorage.key(i); if(k.startsWith('bk_') || k==='app_key_config') data[k] = localStorage.getItem(k); }
        navigator.clipboard.writeText(JSON.stringify(data)).then(()=>Utils.toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
    },
    downloadFile: () => {
        const data = {};
        for(let i=0; i<localStorage.length; i++) { const k = localStorage.key(i); if(k.startsWith('bk_') || k==='app_key_config') data[k] = localStorage.getItem(k); }
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'})); 
        a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; 
        a.click();
    },
    handleFile: (input) => {
        if(input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { document.getElementById('sync-text').value = e.target.result; Utils.toast('æ–‡ä»¶å·²è¯»å–'); };
            r.readAsText(input.files[0]);
        }
    },
    executeImport: () => {
        try {
            const str = document.getElementById('sync-text').value;
            if(!str) throw new Error("å†…å®¹ä¸ºç©º");
            const d = JSON.parse(str);
            for(const k in d) localStorage.setItem(k, d[k]);
            alert('æ¢å¤æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...'); location.reload();
        } catch(e) { alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥'); }
    }
};

const Training = {
    queue: [], current: [], timer: null, round: 0, 
    hasInteracted: false, isPaused: false, timeLeft: 60, focusIndex: -1,
    
    start: (bookId) => {
        const book = StorageManager.get(bookId);
        if(!book || !book.words.length) { Utils.toast('è¿™æœ¬ä¹¦æ˜¯ç©ºçš„', 'error'); return; }
        Training.queue = [...book.words].sort(()=>0.5-Math.random());
        Training.round = 0;
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('training-view').classList.remove('hidden');
        document.getElementById('train-book-title').innerText = book.name;
        window.addEventListener('keydown', Training.handleKeyDown);
        Training.next();
    },
    next: () => {
        clearInterval(Training.timer);
        Training.round++;
        document.getElementById('round-count').innerText = Training.round;
        const batchSize = (Training.round % 3 === 0) ? 10 : 8; // æ¨¡æ‹Ÿå¶æ•°å˜åŒ–
        const batch = Training.queue.splice(0, batchSize);
        if(!batch.length) { alert('ğŸ‰ æ­å–œï¼æœ¬è½®è®­ç»ƒå®Œæˆï¼'); App.endTraining(); return; }
        Training.current = batch.map(w => ({...w, status: 0})); 
        Training.hasInteracted = false; Training.focusIndex = -1; Training.timeLeft = 60; Training.isPaused = false;
        Training.render(); Training.startTimer();
    },
    startTimer: () => {
        clearInterval(Training.timer);
        const bar = document.getElementById('timer-progress');
        bar.style.transition = 'none'; bar.style.width = (Training.timeLeft/60)*100 + '%'; bar.offsetHeight; bar.style.transition = 'width 1s linear';
        Training.timer = setInterval(() => {
            if(Training.isPaused) return; 
            Training.timeLeft--;
            bar.style.width = (Training.timeLeft/60)*100+'%'; 
            if(Training.timeLeft<=0) Training.finishBatch(); 
        }, 1000);
    },
    togglePause: () => {
        Training.isPaused = !Training.isPaused;
        const overlay = document.getElementById('pause-overlay');
        const btn = document.getElementById('pause-btn');
        if(Training.isPaused) {
            overlay.classList.remove('hidden'); btn.innerText = "â–¶ï¸";
            document.getElementById('timer-progress').style.transition = 'none';
        } else {
            overlay.classList.add('hidden'); btn.innerText = "â¸";
            document.getElementById('timer-progress').style.transition = 'width 1s linear';
        }
    },
    finishBatch: () => {
        if (!Training.hasInteracted && Training.timeLeft <= 0) {
            alert("â° æ£€æµ‹åˆ°é•¿æ—¶é—´æ— æ“ä½œï¼Œå·²è‡ªåŠ¨é€€å‡ºè®­ç»ƒã€‚"); App.endTraining(); return;
        }
        const notMastered = Training.current.filter(w => w.status !== 2);
        if(notMastered.length) { 
            const mb = StorageManager.get(App.MISTAKE_ID);
            notMastered.forEach(w => { if(!mb.words.find(x=>x.word===w.word)) mb.words.unshift({...w, id:Utils.uuid(), status:0}); });
            StorageManager.save(App.MISTAKE_ID, mb);
            Training.queue.push(...notMastered); Utils.toast(`${notMastered.length} ä¸ªå•è¯æœªæŒæ¡`); 
        } else { Utils.toast('å…¨å¯¹ï¼å¤ªæ£’äº†'); }
        Training.next();
    },
    handleCardClick: (id) => {
        if(Training.isPaused) return;
        Training.hasInteracted = true;
        const index = Training.current.findIndex(x => x.id === id);
        if(index === -1) return;
        const w = Training.current[index];
        const el = document.getElementById('card-' + id);
        Training.setFocus(index);
        
        // çŠ¶æ€æµè½¬: 0(ç™½) -> 1(çº¢) -> 2(ç»¿) -> 1(çº¢)
        if (w.status === 2) { w.status = 1; el.classList.remove('is-mastered'); el.classList.add('is-reviewing'); }
        else if (w.status === 1) { w.status = 2; el.classList.remove('is-reviewing'); el.classList.add('is-mastered'); }
        else { w.status = 1; el.classList.add('is-reviewing'); }
        
        if(Training.current.every(x => x.status === 2)) setTimeout(Training.finishBatch, 500);
    },
    setFocus: (index) => {
        if (index < 0 || index >= Training.current.length) return;
        if(Training.focusIndex !== -1) { const oldEl = document.getElementById('card-' + Training.current[Training.focusIndex].id); if(oldEl) oldEl.classList.remove('is-keyboard-focus'); }
        Training.focusIndex = index;
        const newEl = document.getElementById('card-' + Training.current[Training.focusIndex].id);
        if(newEl) { newEl.classList.add('is-keyboard-focus'); newEl.scrollIntoView({behavior: "smooth", block: "center"}); }
    },
    handleKeyDown: (e) => {
        if(document.getElementById('training-view').classList.contains('hidden')) return;
        const k = Settings.keys;
        if (e.code === k.pause) { Training.togglePause(); return; }
        if(Training.isPaused) return;
        if (e.code === k.finish) { Training.finishBatch(); return; }
        
        // åŠ¨æ€è·å–åˆ—æ•° (ç”¨äºé”®ç›˜ä¸Šä¸‹ç§»åŠ¨)
        const isPC = window.innerWidth >= 768;
        const cols = isPC ? (Training.current.length / 2) : 2;

        let nextIndex = Training.focusIndex;
        if (nextIndex === -1 && [k.up, k.down, k.left, k.right].includes(e.code)) { Training.setFocus(0); return; }
        if (e.code === k.right) { if ((nextIndex + 1) % cols !== 0) nextIndex++; } 
        else if (e.code === k.left) { if (nextIndex % cols !== 0) nextIndex--; } 
        else if (e.code === k.down) { if (nextIndex + cols < Training.current.length) nextIndex += cols; } 
        else if (e.code === k.up) { if (nextIndex - cols >= 0) nextIndex -= cols; } 
        else if (e.code === k.flip) { e.preventDefault(); if (nextIndex !== -1) Training.handleCardClick(Training.current[nextIndex].id); }
        if (nextIndex !== Training.focusIndex) Training.setFocus(nextIndex);
    },
    
    // --- æ ¸å¿ƒä¿®å¤ï¼šè‡ªåŠ¨è°ƒæ•´å­—å· ---
    adjustFontSize: (el) => {
        let size = 26; // åˆå§‹æœ€å¤§å­—å·
        el.style.fontSize = size + 'px';
        const parent = el.parentElement;
        // å¾ªç¯å‡å°ç›´åˆ°ä¸æº¢å‡ºï¼Œä¸”æœ€å°12px
        while ((el.scrollWidth > parent.clientWidth) && size > 12) {
            size--;
            el.style.fontSize = size + 'px';
        }
    },

    render: () => {
        const c = document.getElementById('card-container'); c.innerHTML='';
        // è®¡ç®—PCç«¯åˆ—æ•°å˜é‡ï¼šæ€»æ•°/2 (ä¾‹å¦‚ 8->4, 10->5)
        c.style.setProperty('--cols', Math.ceil(Training.current.length / 2));
        
        Training.current.forEach(w => {
            const el = document.createElement('div'); el.className='word-card'; el.id='card-'+w.id;
            if(w.status === 1) el.classList.add('is-reviewing');
            if(w.status === 2) el.classList.add('is-mastered');
            el.onclick = () => Training.handleCardClick(w.id);
            el.innerHTML = `<div class="card-inner"><div class="card-front"><div class="check-mark">âœ…</div><div class="section-top"><div class="word-text">${w.word}</div></div><div class="section-bottom"></div></div><div class="card-back"><div class="section-top"><div class="word-text">${w.word}</div></div><div class="section-bottom"><div class="word-meaning">${w.meaning}</div></div></div></div>`;
            c.appendChild(el);
            // æ¸²æŸ“åè°ƒæ•´å­—å·
            requestAnimationFrame(() => {
                const texts = el.querySelectorAll('.word-text');
                texts.forEach(t => Training.adjustFontSize(t));
            });
        });
    }
};

const App = {
    MISTAKE_ID: 'system_mistakes', isManageMode: false,
    init: () => { Settings.init(); if(!StorageManager.get(App.MISTAKE_ID)) StorageManager.save(App.MISTAKE_ID, {id:App.MISTAKE_ID, name:'ğŸ“… é”™é¢˜æœ¬', words:[], isSystem:true}); App.renderList(); },
    toggleManageMode: () => { App.isManageMode = !App.isManageMode; document.body.classList.toggle('manage-mode', App.isManageMode); document.getElementById('manage-btn').innerText = App.isManageMode ? 'å®Œæˆ' : 'âš™ï¸ ç®¡ç†'; document.getElementById('manage-btn').style.color = App.isManageMode ? 'var(--primary)' : 'var(--text-sub)'; App.renderList(); },
    handleDelete: (bookId, event) => { event.stopPropagation(); if(confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) { StorageManager.remove(bookId); App.renderList(); } },
    handleExport: (bookId, event) => {
        event.stopPropagation();
        const book = StorageManager.get(bookId); if(!book) return;
        let content = `--- ${book.name} ---\n\n`;
        const maxLen = Math.max(...book.words.map(w => w.word.length), 10) + 4;
        book.words.forEach(w => { content += `${w.word.padEnd(maxLen)} ${w.meaning}\n`; });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], {type: 'text/plain'})); a.download = `${book.name}_å•è¯è¡¨.txt`; a.click();
    },
    renderList: () => {
        const list = document.getElementById('book-list'); list.innerHTML = '';
        const books = StorageManager.getAllBooks();
        books.forEach(b => {
            const el = document.createElement('div'); el.className = 'book-card';
            el.onclick = () => { if(!App.isManageMode) Training.start(b.id); };
            el.innerHTML = `<div class="book-info"><div class="book-title">${b.name}</div><div class="book-meta">${b.words.length} è¯ ${b.isSystem?'(ç³»ç»Ÿ)':''}</div></div><div class="book-arrow">âœ</div><div class="manage-actions"><button class="btn btn-outline" style="padding:6px 12px; font-size:13px" onclick="App.handleExport('${b.id}', event)">ğŸ“¥ å¯¼å‡º</button><button class="btn btn-danger" style="padding:6px 12px; font-size:13px" onclick="App.handleDelete('${b.id}', event)">ğŸ—‘ åˆ é™¤</button></div>`;
            list.appendChild(el);
        });
        if(books.length === 0) list.innerHTML = '<div style="text-align:center;color:#999;padding:40px">ä¹¦æ¶æ˜¯ç©ºçš„</div>';
    },
    // ä¿®å¤ç‚¹ï¼šç¡®ä¿è¯»å–åˆ°æ–‡ä»¶æˆ–æ–‡æœ¬æ¡†å†…å®¹
    processImport: () => {
        const text = document.getElementById('import-text').value;
        const name = document.getElementById('import-name-input').value;
        const words = Utils.parseWords(text);
        if(words.length === 0) { Utils.toast('å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯', 'error'); return; }
        StorageManager.save(Utils.uuid(), { id: Utils.uuid(), name: name || 'æ–°ä¹¦ '+new Date().toLocaleDateString(), words: words, isSystem: false });
        App.closeModals(); App.renderList(); Utils.toast(`å¯¼å…¥ ${words.length} è¯`);
    },
    showImportModal: () => { document.getElementById('import-modal').classList.remove('hidden'); },
    showSyncModal: () => { document.getElementById('sync-modal').classList.remove('hidden'); },
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.add('hidden')),
    // ä¿®å¤ç‚¹ï¼šæ–‡ä»¶é€‰æ‹©åç«‹å³å›å¡«åˆ°æ–‡æœ¬æ¡†
    handleFileSelect: (input) => { 
        if(input.files[0]) { 
            const r = new FileReader(); 
            r.onload = (e) => { 
                document.getElementById('import-text').value = e.target.result; 
                Utils.toast('æ–‡ä»¶å†…å®¹å·²è¯»å–');
            }; 
            r.readAsText(input.files[0]); 
        } 
    },
    endTraining: () => { clearInterval(Training.timer); window.removeEventListener('keydown', Training.handleKeyDown); document.getElementById('training-view').classList.add('hidden'); document.getElementById('bookshelf-view').classList.remove('hidden'); App.renderList(); }
};

window.onload = App.init;
</script>
</body>
</html>
