<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•è¯è®­ç»ƒå™¨ (è‡ªåŠ¨ç”Ÿæˆé”™é¢˜æœ¬ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4F46E5;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;  /* çº¢è‰²ï¼šæœªæŒæ¡ */
            --success: #10B981; /* ç»¿è‰²ï¼šå·²æŒæ¡ */
            --focus-ring: #818cf8;
            --radius: 16px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        html { box-sizing: border-box; -webkit-tap-highlight-color: transparent; scrollbar-gutter: stable; }
        body { margin: 0; padding: 0; font-family: var(--font-stack); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        * { box-sizing: border-box; }

        .btn { border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; outline: none; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); }
        .btn-outline { border: 1px solid #E5E7EB; background: white; color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        
        .hidden { display: none !important; }
        .view { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        header { background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; z-index: 50; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--text-main); }

        #bookshelf-view { overflow-y: auto; padding: 20px; }
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; padding-bottom: 40px; }
        
        .book-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            height: 90px; position: relative; overflow: hidden; transition: all 0.2s; cursor: pointer;
        }
        .book-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        
        .book-info { flex: 1; pointer-events: none; }
        .book-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #111827; }
        .book-arrow { font-size: 18px; color: #E5E7EB; margin-left: 10px; }
        .manage-actions { display: none; position: absolute; inset: 0; background: rgba(255, 255, 255, 0.95); z-index: 10; align-items: center; justify-content: center; gap: 10px; }
        body.manage-mode .manage-actions { display: flex; animation: fadeIn 0.2s; }
        body.manage-mode .book-card { transform: none !important; cursor: default; }

        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--bg-body); display: flex; flex-direction: column; }
        .timer-bar { height: 4px; background: #e5e7eb; width: 100%; }
        .timer-progress { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        .training-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        
        .layout-grid { display: grid; gap: 15px; width: 100%; height: 100%; transition: all 0.3s ease; }
        @media (max-width: 768px) { .layout-grid { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 160px; height: auto; } }
        @media (min-width: 768px) { 
            .training-container { justify-content: center; padding: 40px; }
            .layout-grid { grid-template-columns: repeat(var(--cols, 4), 1fr); grid-template-rows: repeat(2, 1fr); height: 100%; max-height: 85vh; }
            .word-card { height: 100% !important; }
        }
        
        .word-card { background: transparent; perspective: 1000px; height: 160px; cursor: pointer; position: relative; touch-action: manipulation; }
        /* é”®ç›˜é€‰ä¸­é«˜äº® */
        .word-card.keyboard-focus .card-inner { box-shadow: 0 0 0 4px var(--focus-ring), 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.02); z-index: 10; }
        
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* çŠ¶æ€æ ·å¼ */
        .word-card.is-reviewing .card-inner { transform: rotateY(180deg); }
        .word-card.is-mastered .card-inner { transform: rotateY(0deg); } /* ç¿»å›æ­£é¢ */

        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: var(--radius); border: 2px solid #e5e7eb; background: white; overflow: hidden; display: flex; flex-direction: column; }
        .card-front { z-index: 2; background: white; color: var(--text-main); }
        
        /* èƒŒé¢(çº¢) */
        .card-back { z-index: 1; transform: rotateY(180deg); background: #FFF1F2; border-color: var(--danger); }

        /* æ­£é¢(ç»¿) */
        .word-card.is-mastered .card-front { border: 3px solid var(--success); background-color: #ECFDF5; }
        
        .check-mark { position: absolute; top: 10px; right: 10px; color: var(--success); font-size: 20px; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .word-card.is-mastered .check-mark { opacity: 1; transform: scale(1); }

        .section-top { height: 45%; width: 100%; display: flex; align-items: center; justify-content: center; padding: 0 10px; border-bottom: 1px dashed transparent; }
        .word-text { font-size: 26px; font-weight: 800; color: var(--text-main); white-space: nowrap; line-height: 1; padding: 0 5px; }
        .section-bottom { 
            height: 55%; width: 100%; padding: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
            overflow-y: auto; background: rgba(0,0,0,0.01);
            opacity: 0; transition: opacity 0.2s ease;
        }
        
        .word-card:hover .section-bottom, .word-card.keyboard-focus .section-bottom { opacity: 1; }
        .layout-grid.force-show .section-bottom { opacity: 1 !important; }

        .card-back .section-top { border-bottom-color: #FECACA; }
        .card-back .word-meaning { font-size: 15px; line-height: 1.6; color: #4B5563; }
        
        .pause-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 150; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: flex-end; justify-content: center; z-index: 200; backdrop-filter: blur(2px); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 90%; max-width: 420px; border-radius: 20px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay:not(.hidden) .modal { transform: scale(1); }
        .code-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; background: #1e293b; color: #e2e8f0; font-family: var(--font-mono); font-size: 13px; resize: none; margin: 10px 0; outline: none; }
        .styled-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin: 10px 0; font-size: 14px; outline: none; }
        .file-input-hidden { position: absolute; width: 1px; height: 1px; opacity: 0; overflow: hidden; }
        .key-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .key-badge { background: white; padding: 6px 10px; border-radius: 6px; font-family: var(--font-mono); font-size: 13px; font-weight: bold; border: 1px solid #d1d5db; cursor: pointer; min-width: 70px; text-align: center; }
        .key-badge.recording { background: var(--primary); color: white; border-color: var(--primary); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(17, 24, 39, 0.95); color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; font-weight: 500; z-index: 999; pointer-events: none; opacity: 0; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>

    <div id="bookshelf-view" class="view">
        <header>
            <button class="btn btn-ghost" onclick="App.toggleManage()" id="manage-btn">âš™ï¸ ç®¡ç†</button>
            <h1>æˆ‘çš„å•è¯æœ¬</h1>
            <div style="display:flex; gap:5px">
                <button class="btn btn-ghost" onclick="UI.showModal('settings-modal')">âŒ¨ï¸</button>
                <button class="btn btn-ghost" onclick="UI.showModal('sync-modal')">â˜ï¸</button>
                <button class="btn btn-primary" onclick="UI.showModal('import-modal')">+ å¯¼å…¥</button>
            </div>
        </header>
        <div id="book-list" class="book-list"></div>
    </div>

    <div id="training-view" class="full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="Training.quit()">âœ• é€€å‡º</button>
            <div style="text-align: center;">
                <h1 id="train-book-title" style="font-size: 16px; margin:0;">è®­ç»ƒä¸­</h1>
                <span style="font-size: 12px; color: var(--text-sub)">è½®æ¬¡ <span id="round-num">1</span></span>
            </div>
            <div style="display:flex; gap:5px">
                <button class="btn btn-ghost" id="mode-btn" onclick="Training.toggleMode()">ğŸ‘ï¸ æ‚¬åœ</button>
                <button class="btn btn-ghost" id="pause-btn" onclick="Training.togglePause()">â¸</button>
            </div>
        </header>
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        <div style="background:#fff7ed; color:#c2410c; padding:8px; text-align:center; font-size:12px;">æç¤º: ä¸€æ¬¡ç¿»è½¬æ ‡çº¢(æœªæŒæ¡)ï¼ŒäºŒæ¬¡ç¿»è½¬æ ‡ç»¿(å·²æŒæ¡)</div>
        <div class="training-container">
            <div id="card-container" class="layout-grid"></div>
        </div>
        <div style="padding:15px; background:white; border-top:1px solid #eee; text-align:center;">
            <button class="btn btn-outline" style="width:100%" id="finish-btn" onclick="Training.finish()">æå‰ç»“ç®—</button>
        </div>
        <div id="pause-overlay" class="hidden">
            <div style="font-size: 40px; margin-bottom: 15px;">â¸</div>
            <h2 style="color: var(--text-main); margin-top: 0;">è®­ç»ƒå·²æš‚åœ</h2>
            <button class="btn btn-primary" onclick="Training.togglePause()" style="padding: 12px 30px; margin-top:10px;">ç»§ç»­è®­ç»ƒ</button>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>å¯¼å…¥æ–°ä¹¦</h3>
            <div style="margin-bottom:10px">
                <button class="btn btn-outline" onclick="document.getElementById('file-input').click()" style="width:100%">ğŸ“‚ é€‰æ‹©æ–‡ä»¶ (TXT)</button>
                <input type="file" id="file-input" class="file-input-hidden" onchange="Data.readFile(this, 'import-text')" onclick="this.value=null">
            </div>
            <textarea id="import-text" class="code-input" rows="5" placeholder="æˆ–åœ¨æ­¤ç²˜è´´æ–‡æœ¬...&#10;æ ¼å¼: apple è‹¹æœ"></textarea>
            <input type="text" id="import-name" class="styled-input" placeholder="ä¹¦å (å¯é€‰)">
            <div style="display:flex; gap:10px; margin-top:10px">
                <button class="btn btn-ghost" style="flex:1" onclick="UI.closeModals()">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex:1" onclick="Data.importBook()">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    <div id="sync-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn btn-outline" style="flex:1" onclick="SyncSys.exportData()">ğŸ“‹ å¤åˆ¶</button>
                <button class="btn btn-outline" style="flex:1" onclick="SyncSys.downloadFile()">ğŸ’¾ ä¸‹è½½</button>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <div style="margin-bottom:10px;">
                <button class="btn btn-outline" style="width:100%" onclick="document.getElementById('backup-file-input').click()">ğŸ“‚ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶</button>
                <input type="file" id="backup-file-input" class="file-input-hidden" onchange="Data.readFile(this, 'sync-text')" onclick="this.value=null">
            </div>
            <textarea id="sync-text" class="code-input" rows="4" placeholder="ç²˜è´´æ•°æ®ç ..."></textarea>
            <div style="display:flex; gap:10px; margin-top:10px">
                <button class="btn btn-ghost" style="flex:1" onclick="UI.closeModals()">å…³é—­</button>
                <button class="btn btn-primary" style="flex:1" onclick="SyncSys.executeImport()">æ¢å¤</button>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>æŒ‰é”®è®¾ç½®</h3>
            <div id="keys-list" style="max-height:300px; overflow-y:auto"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="UI.closeModals()">å®Œæˆ</button>
        </div>
    </div>
    <div id="toast"></div>

<script>
const UI = {
    toast: (msg, type='success') => {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = 1; t.style.top = '20px';
        setTimeout(() => { t.style.opacity = 0; t.style.top = '-50px'; }, 2000);
    },
    showModal: (id) => document.getElementById(id).classList.remove('hidden'),
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden')),
    renderBooks: () => {
        const list = document.getElementById('book-list'); list.innerHTML = '';
        State.books.forEach(book => {
            const el = document.createElement('div'); el.className = 'book-card';
            el.innerHTML = `<div class="book-info"><h3>${book.name}</h3><span>${book.words.length} è¯</span></div><div class="book-arrow">âœ</div><div class="manage-actions"><button class="btn btn-danger" onclick="Data.deleteBook('${book.id}', event)">åˆ é™¤</button><button class="btn btn-outline" onclick="Data.exportTxt('${book.id}', event)">TXT</button></div>`;
            el.onclick = () => !document.body.classList.contains('manage-mode') && Training.start(book.id);
            list.appendChild(el);
        });
        if(State.books.length === 0) list.innerHTML = '<div style="text-align:center; padding:20px; color:#999; grid-column:1/-1">æš‚æ— å•è¯ä¹¦ï¼Œè¯·å¯¼å…¥</div>';
    },
    renderKeys: () => {
        const list = document.getElementById('keys-list'); list.innerHTML = '';
        const labels = { up:'ä¸Šç§»', down:'ä¸‹ç§»', left:'å·¦ç§»', right:'å³ç§»', flip:'ç¿»è½¬', pause:'æš‚åœ', finish:'ç»“ç®—' };
        for(let action in State.keys) {
            const row = document.createElement('div'); row.className = 'key-row';
            row.innerHTML = `<span>${labels[action]}</span> <div class="key-badge" onclick="UI.bindKey('${action}', this)">${State.keys[action]}</div>`;
            list.appendChild(row);
        }
    },
    bindKey: (action, btn) => {
        btn.innerText = '...'; btn.classList.add('recording');
        const handler = (e) => { e.preventDefault(); State.keys[action] = e.code; localStorage.setItem('app_keys', JSON.stringify(State.keys)); UI.renderKeys(); window.removeEventListener('keydown', handler); };
        window.addEventListener('keydown', handler, {once:true});
    }
};

const State = {
    books: [],
    keys: { up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD', flip:'Space', pause:'KeyP', finish:'Enter' },
    training: { queue: [], currentBatch: [], timer: null, timeLeft: 60, round: 1, paused: false, focusIndex: -1, hasInteracted: false, alwaysShow: false, sessionMistakes: [] }
};

const Data = {
    init: () => {
        const stored = localStorage.getItem('app_data');
        if(stored) State.books = JSON.parse(stored);
        else { State.books = []; Data.save(); }
        const keys = localStorage.getItem('app_keys');
        if(keys) State.keys = JSON.parse(keys);
        UI.renderBooks(); UI.renderKeys();
    },
    save: () => localStorage.setItem('app_data', JSON.stringify(State.books)),
    parseWords: (text) => {
        const words = [];
        text.split('\n').forEach(line => {
            const parts = line.trim().split(/[:\s\t]+(.+)/);
            if(parts.length >= 2) words.push({ word: parts[0], meaning: parts[1], id: Date.now()+Math.random() });
        });
        return words;
    },
    readFile: (input, targetId) => {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => { document.getElementById(targetId).value = e.target.result; UI.toast('å·²è¯»å–'); };
            r.readAsText(input.files[0]);
        }
    },
    importBook: () => {
        const text = document.getElementById('import-text').value;
        const name = document.getElementById('import-name').value || 'æ–°å•è¯ä¹¦';
        if(!text.trim()) return UI.toast('å†…å®¹ä¸ºç©º');
        let words = [];
        try {
            const json = JSON.parse(text);
            if(Array.isArray(json)) json.forEach(w => { if(w.word || w.w) words.push({ word: w.word||w.w, meaning: w.meaning||w.m, id: Date.now()+Math.random() }) });
        } catch(e) { words = Data.parseWords(text); }
        if(words.length === 0) return UI.toast('æ ¼å¼é”™è¯¯');
        State.books.push({ id: Date.now().toString(), name: name, words: words });
        Data.save(); UI.renderBooks(); UI.closeModals(); UI.toast(`å¯¼å…¥ ${words.length} è¯`);
    },
    deleteBook: (id, e) => { e.stopPropagation(); if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { State.books = State.books.filter(b => b.id !== id); Data.save(); UI.renderBooks(); } },
    exportTxt: (id, e) => {
        e.stopPropagation();
        const book = State.books.find(b => b.id === id);
        let c = `--- ${book.name} ---\n`; book.words.forEach(w => c += `${w.word} ${w.meaning}\n`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type:'text/plain'})); a.download = `${book.name}.txt`; a.click();
    },
    importAll: () => {
        try {
            const d = JSON.parse(document.getElementById('sync-text').value);
            if(Array.isArray(d)) State.books = d;
            else { State.books = []; for(let k in d) if(k.startsWith('bk_')) State.books.push(JSON.parse(d[k])); }
            Data.save(); UI.renderBooks(); UI.closeModals(); UI.toast('æ¢å¤æˆåŠŸ');
        } catch(e) { UI.toast('æ•°æ®æ ¼å¼é”™è¯¯'); }
    }
};

const SyncSys = {
    exportData: () => { navigator.clipboard.writeText(JSON.stringify(State.books)); UI.toast('å·²å¤åˆ¶'); },
    downloadFile: () => {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(State.books)], {type:'application/json'})); a.download = 'backup.json'; a.click();
    },
    executeImport: Data.importAll 
};

// --- Training Logic ---
const Training = {
    start: (bookId) => {
        const book = State.books.find(b => b.id === bookId);
        if(!book || book.words.length === 0) return UI.toast('ç©ºä¹¦');
        State.training.queue = [...book.words].sort(()=>0.5-Math.random());
        State.training.round = 0;
        State.training.sessionMistakes = []; // åˆå§‹åŒ–æœ¬æ¬¡é”™é¢˜
        State.training.alwaysShow = false; 
        Training.updateModeUI();
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('training-view').classList.remove('hidden');
        document.getElementById('train-book-title').innerText = book.name;
        window.addEventListener('keydown', Training.onKey);
        Training.nextRound();
    },
    
    // ç”Ÿæˆé”™é¢˜æœ¬æ ¸å¿ƒé€»è¾‘
    saveSessionMistakes: () => {
        const mistakes = State.training.sessionMistakes;
        if (mistakes.length > 0) {
            const now = new Date();
            const timeStr = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const newBookName = `ğŸ“… é”™é¢˜ ${timeStr}`;
            // å»é‡ï¼ˆè™½ç„¶æµç¨‹ä¸Šä¸€èˆ¬ä¸ä¼šæœ‰é‡å¤ï¼Œä¿é™©èµ·è§ï¼‰
            const uniqueMistakes = [];
            const seen = new Set();
            mistakes.forEach(w => { if(!seen.has(w.word)) { seen.add(w.word); uniqueMistakes.push(w); }});
            
            const newBook = { id: 'err_' + Date.now(), name: newBookName, words: uniqueMistakes };
            State.books.unshift(newBook); // æ·»åŠ åˆ°æœ€å‰é¢
            Data.save();
            UI.toast(`ç”Ÿæˆ: ${newBookName}`);
        }
    },

    toggleMode: () => {
        State.training.alwaysShow = !State.training.alwaysShow;
        Training.updateModeUI();
    },
    updateModeUI: () => {
        const btn = document.getElementById('mode-btn');
        const container = document.getElementById('card-container');
        if(State.training.alwaysShow) {
            btn.innerText = 'ğŸ‘ï¸ å›ºå®š';
            btn.style.color = 'var(--primary)';
            container.classList.add('force-show');
        } else {
            btn.innerText = 'ğŸ‘ï¸ æ‚¬åœ';
            btn.style.color = 'var(--text-sub)';
            container.classList.remove('force-show');
        }
    },
    nextRound: () => {
        const t = State.training;
        if(t.queue.length === 0) { alert('è®­ç»ƒå®Œæˆï¼è‡ªåŠ¨ä¿å­˜é”™é¢˜ã€‚'); return Training.quit(); }
        t.round++; document.getElementById('round-num').innerText = t.round;
        const batchSize = (t.round % 3 === 0) ? 10 : 8;
        t.currentBatch = t.queue.splice(0, batchSize).map(w => ({ ...w, status: 0 }));
        t.focusIndex = -1; t.hasInteracted = false; t.timeLeft = 60; t.paused = false;
        Training.renderCards(); 
        Training.startTimer();
    },
    renderCards: () => {
        const c = document.getElementById('card-container'); c.innerHTML = '';
        const words = State.training.currentBatch;
        if(window.innerWidth >= 768) c.style.gridTemplateColumns = `repeat(${Math.ceil(words.length/2)}, 1fr)`;
        words.forEach((item, index) => {
            const el = document.createElement('div'); el.className = 'word-card';
            Training.applyCardClasses(el, item, index);
            el.innerHTML = `<div class="card-inner">
                <div class="card-front"><div class="check-mark">âœ…</div><div class="section-top"><div class="word-text">${item.word}</div></div><div class="section-bottom"></div></div>
                <div class="card-back"><div class="section-top"><div class="word-text">${item.word}</div></div><div class="section-bottom"><div class="word-meaning">${item.meaning}</div></div></div>
            </div>`;
            el.onclick = () => Training.handleClick(index);
            c.appendChild(el);
            setTimeout(() => el.querySelectorAll('.word-text').forEach(t => Training.fitText(t)), 0);
        });
    },
    applyCardClasses: (el, item, index) => {
        el.classList.remove('flipped', 'is-reviewing', 'is-mastered', 'keyboard-focus');
        if(item.status === 1) el.classList.add('flipped', 'is-reviewing');
        if(item.status === 2) el.classList.add('is-mastered');
        if(index === State.training.focusIndex) el.classList.add('keyboard-focus');
    },
    updateSingleCardUI: (index) => {
        const el = document.getElementById('card-container').children[index];
        if(el) Training.applyCardClasses(el, State.training.currentBatch[index], index);
    },
    fitText: (el) => {
        let size = 26; el.style.fontSize = size + 'px';
        const w = el.parentElement.offsetWidth - 10;
        while(el.scrollWidth > w && size > 12) { size--; el.style.fontSize = size + 'px'; }
    },
    handleClick: (index) => {
        if(State.training.paused) return;
        const oldFocus = State.training.focusIndex;
        if(oldFocus !== -1 && oldFocus !== index) { State.training.focusIndex = -1; Training.updateSingleCardUI(oldFocus); }
        State.training.focusIndex = -1; 
        State.training.hasInteracted = true;
        Training.toggleStatus(index);
        Training.updateSingleCardUI(index);
    },
    toggleStatus: (index) => {
        const item = State.training.currentBatch[index];
        if(item.status === 0) item.status = 1;
        else if(item.status === 1) item.status = 2;
        else if(item.status === 2) item.status = 1;
        if(State.training.currentBatch.every(w => w.status === 2)) setTimeout(Training.finish, 500);
    },
    onKey: (e) => {
        if(State.training.paused) return;
        const k = State.training; const keys = State.keys;
        const cols = (window.innerWidth >= 768) ? Math.ceil(k.currentBatch.length/2) : 2;
        let next = k.focusIndex; const oldIndex = k.focusIndex; 
        if(e.code === keys.pause) return Training.togglePause();
        if(e.code === keys.finish) return Training.finish();
        if(next === -1 && [keys.up, keys.down, keys.left, keys.right].includes(e.code)) { 
            k.focusIndex = 0; Training.updateSingleCardUI(0); return; 
        }
        if(e.code === keys.right) { if((next+1)%cols !== 0) next++; }
        else if(e.code === keys.left) { if(next%cols !== 0) next--; }
        else if(e.code === keys.down) { if(next+cols < k.currentBatch.length) next += cols; }
        else if(e.code === keys.up) { if(next-cols >= 0) next -= cols; }
        else if(e.code === keys.flip) {
            e.preventDefault();
            if(next !== -1) { k.hasInteracted = true; Training.toggleStatus(next); Training.updateSingleCardUI(next); }
        }
        if(next !== oldIndex) { 
            k.focusIndex = next; 
            if(oldIndex !== -1) Training.updateSingleCardUI(oldIndex);
            Training.updateSingleCardUI(next);
        }
    },
    togglePause: () => {
        const t = State.training; t.paused = !t.paused;
        const o = document.getElementById('pause-overlay');
        const b = document.getElementById('pause-btn');
        if(t.paused) { o.classList.remove('hidden'); b.innerText = 'â–¶ï¸'; clearInterval(t.timer); }
        else { o.classList.add('hidden'); b.innerText = 'â¸'; Training.startTimer(); }
    },
    startTimer: () => {
        clearInterval(State.training.timer);
        const bar = document.getElementById('timer-progress');
        bar.style.transition = 'width 1s linear'; bar.style.width = (State.training.timeLeft/60)*100 + '%';
        State.training.timer = setInterval(() => {
            const t = State.training; if(t.paused) return;
            t.timeLeft--; bar.style.width = (t.timeLeft/60)*100 + '%';
            if(t.timeLeft <= 0) Training.finish();
        }, 1000);
    },
    finish: () => {
        const t = State.training;
        if(!t.hasInteracted && t.timeLeft <= 0) { alert('è¶…æ—¶è‡ªåŠ¨é€€å‡º'); return Training.quit(); }
        const failed = t.currentBatch.filter(w => w.status !== 2);
        
        // --- é”™é¢˜æ”¶é›†é€»è¾‘ ---
        if(failed.length > 0) {
            // å°†æœªæŒæ¡å•è¯åŠ å…¥æœ¬æ¬¡é”™é¢˜é›† (å¦‚æœè¿˜æ²¡åŠ è¿‡)
            failed.forEach(w => {
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ”¶é›†å•è¯çš„åŸå§‹ä¿¡æ¯
                if (!t.sessionMistakes.some(sw => sw.word === w.word)) {
                    t.sessionMistakes.push({ word: w.word, meaning: w.meaning, id: Date.now() + Math.random() });
                }
            });
            // é‡æ–°åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨è¿›è¡Œå¾ªç¯è®­ç»ƒ
            t.queue.push(...failed);
            UI.toast(`${failed.length} ä¸ªå•è¯æœªæŒæ¡`);
        } else {
            UI.toast('å…¨å¯¹ï¼');
        }
        // -------------------
        
        Training.nextRound();
    },
    quit: () => {
        // é€€å‡ºæ—¶ä¿å­˜é”™é¢˜æœ¬
        Training.saveSessionMistakes();
        
        clearInterval(State.training.timer);
        window.removeEventListener('keydown', Training.onKey);
        document.getElementById('training-view').classList.add('hidden');
        document.getElementById('bookshelf-view').classList.remove('hidden');
        UI.renderBooks();
    }
};

const App = {
    toggleManage: () => {
        document.body.classList.toggle('manage-mode');
        document.getElementById('manage-btn').style.color = document.body.classList.contains('manage-mode') ? 'var(--primary)' : 'var(--text-sub)';
    }
};

window.onload = Data.init;
</script>
</body>
</html>
