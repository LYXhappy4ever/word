<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•è¯è®­ç»ƒå™¨ v51.10 (è§¦æ§ç„¦ç‚¹ä¿®å¤ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-bg: #EEF2FF;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --radius: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        html { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        /* å¼ºåˆ¶å…¨å±€ç¨³å®šï¼Œå¹¶éšè—æ°´å¹³æ»šåŠ¨æ¡ */
        body { 
            margin: 0; padding: 0; 
            font-family: var(--font-stack); 
            background: var(--bg-body); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            user-select: none; 
            perspective: 1000px; 
            overflow-x: hidden; 
        }
        * { box-sizing: border-box; }

        /* --- åŸºç¡€ç»„ä»¶ --- */
        .btn { border: none; padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; outline: none; white-space: nowrap; flex-shrink: 0; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
        .btn-outline { border: 1px solid #E5E7EB; background: white; color: var(--text-main); }
        .btn-icon { padding: 8px; border-radius: 50%; width: 32px; height: 32px; }
        
        select { padding: 8px 30px 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: white; font-size: 13px; cursor: pointer; }
        .hidden { display: none !important; }
        .view { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        /* --- å¤´éƒ¨æ  --- */
        header { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); 
            padding: 8px 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #e5e7eb; 
            z-index: 50; flex-shrink: 0; 
            height: 50px; 
            gap: 10px; 
        }
        
        header > .btn, 
        header > .header-actions { flex-shrink: 0 !important; }

        .header-center { flex: 1; min-width: 0; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .header-title-text { font-size: 15px; font-weight: 700; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; display: block; }

        /* --- ä¹¦æ¶ --- */
        .breadcrumb-bar { padding: 10px 16px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 5px; font-size: 14px; color: var(--text-sub); overflow-x: auto; flex-shrink: 0; }
        .crumb { cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; white-space: nowrap; }
        .crumb:hover { background: #f3f4f6; color: var(--primary); }
        .crumb.active { font-weight: bold; color: var(--text-main); cursor: default; }

        .file-area { flex: 1; overflow-y: auto; padding: 16px; position: relative; } 
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; padding-bottom: 60px; }
        
        .item-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 2px solid transparent;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            height: 150px; position: relative; transition: all 0.2s; cursor: pointer;
            justify-content: space-between; z-index: 1;
        }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 8px 12px -3px rgba(0,0,0,0.1); border-color: #e5e7eb; z-index: 5; }
        .item-card.selected { background-color: var(--primary-bg); border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .item-icon { font-size: 36px; margin-bottom: 5px; }
        .item-name { 
            font-size: 14px; font-weight: 600; color: #374151; width: 100%; 
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; white-space: normal; line-height: 1.35;
            min-height: 38px; display: flex; align-items: center; justify-content: center;
        }
        .item-meta { font-size: 11px; color: #9ca3af; margin-top: 4px; padding: 2px 6px; border-radius: 4px; }
        .item-actions-row { display: flex; gap: 2px; width: 100%; justify-content: center; opacity: 0; transition: opacity 0.2s; margin-top: 5px; }
        .item-card:hover .item-actions-row { opacity: 1; }

        /* --- è®­ç»ƒè§†å›¾ --- */
        .full-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; 
            background: var(--bg-body); display: flex; flex-direction: column; 
            transform: translateZ(0); 
            will-change: transform;
        }
        .timer-bar { height: 4px; background: #e5e7eb; width: 100%; flex-shrink: 0; }
        .timer-progress { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        
        .training-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 12px; 
            display: flex; 
            flex-direction: column; 
        }
        .layout-grid { 
            display: grid; 
            gap: 10px; 
            width: 100%; 
            height: 100%; 
            transition: all 0.3s ease; 
        }
        @media (min-width: 768px) { .layout-grid { grid-template-columns: repeat(var(--cols, 4), 1fr); grid-template-rows: repeat(2, 1fr); max-height: 85vh; } }
        @media (max-width: 768px) { .layout-grid { grid-template-columns: repeat(2, 1fr); grid-auto-rows: 160px; height: auto; padding-bottom: 80px; } }
        
        .word-card { 
            background: transparent; 
            perspective: 1000px; 
            cursor: pointer; 
            position: relative; 
            touch-action: manipulation; 
            height: 100%; 
            transform: translateZ(0); 
            will-change: transform;
        }
        .card-inner { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            text-align: center; 
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-style: preserve-3d; 
            border-radius: var(--radius); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            backface-visibility: hidden; 
        }
        .word-card.state-white .card-inner { transform: rotateY(0deg); }
        .word-card.state-red .card-inner    { transform: rotateY(180deg); }
        .word-card.state-green .card-inner { transform: rotateY(0deg); }
        .card-front, .card-back { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            -webkit-backface-visibility: hidden; 
            backface-visibility: hidden; 
            border-radius: var(--radius); 
            border: 2px solid #e5e7eb; 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            transform: translateZ(0.1px); 
        }

        /* --- é‡ç‚¹ä¿®å¤: é˜²æ­¢ç‚¹å‡»åº•éƒ¨å¡ç‰‡æ—¶æµè§ˆå™¨åœ°å€æ /å·¥å…·æ çš„æŠ–åŠ¨ --- */
        /* ç§»é™¤ word-card çš„ transform: translateZ(0.1px) å±æ€§ï¼Œä»…ä¿ç•™ card-front/card-back ä¸Šçš„å±æ€§ */
        /* å¹¶åœ¨JSä¸­å°è¯•é˜»æ­¢é»˜è®¤è¡Œä¸º */
        
        .card-front { z-index: 2; background: white; color: var(--text-main); transform: rotateY(0deg); }
        .card-back { z-index: 1; background: #FFF1F2; border-color: #FECACA; transform: rotateY(180deg); }
        .word-card.state-green .card-front { border: 3px solid var(--success); background-color: #ecfdf5; }
        .check-mark { position: absolute; top: 8px; right: 8px; color: var(--success); font-size: 20px; opacity: 0; transform: scale(0.5); transition: all 0.2s; z-index: 5; }
        .word-card.state-green .check-mark { opacity: 1; transform: scale(1); }
        .section-top { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; width: 100%; }
        .section-bottom { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; background: rgba(0,0,0,0.02); width: 100%; }
        .word-text { font-size: 20px; font-weight: 800; word-break: break-all; padding: 0 25px; }
        .word-meaning { font-size: 15px; color: var(--text-sub); transition: opacity 0.3s ease; opacity: 0; }
        .word-card.state-white .card-front .word-meaning { display: none; }
        .word-card.state-red .card-back .word-meaning { opacity: 0; }
        @media (hover: hover) { .word-card.state-red:hover .card-back .word-meaning { opacity: 1; } }
        .training-container.show-all-meanings .word-card.state-red .card-back .word-meaning { opacity: 1 !important; }
        .word-card.state-green .card-front .word-meaning { opacity: 1; display: block; }

        /* --- æ°”æ³¡æ± è§†å›¾ (3Dç¿»è½¬ + 0.35s ä¼˜åŒ–æ›²çº¿) --- */
        #pool-view { background: #f0f4f8; }
        .pool-container { padding: 20px; flex: 1; display: flex; flex-wrap: wrap; gap: 12px; align-content: flex-start; justify-content: center; overflow-y: auto; perspective: 800px; }
        
        .bubble { 
            display: inline-grid; 
            grid-template-areas: "stack"; 
            cursor: pointer; 
            user-select: none; 
            transform-style: preserve-3d; 
            transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            max-width: 90vw; 
            transform: translateZ(0);
        }
        
        /* çŠ¶æ€1(Flipped/Back) */
        .bubble.flipped { transform: rotateY(180deg); }
        
        .bubble.vanish { transform: scale(0); opacity: 0; transition: all 0.5s; }

        .bubble-face { 
            grid-area: stack; 
            -webkit-backface-visibility: hidden; backface-visibility: hidden; 
            padding: 8px 16px; 
            border-radius: 20px; 
            background: white; 
            border: 1px solid #e2e7eb; 
            display: flex; align-items: center; justify-content: center; 
            width: 100%; height: 100%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            transform: translateZ(0.1px); 
        }

        .face-front { transform: rotateY(0deg); color: var(--text-main); font-weight: 500; z-index: 2; }
        .face-back { transform: rotateY(180deg); background: #EEF2FF; color: var(--primary); border-color: #C7D2FE; font-size: 0.9em; z-index: 1; }

        /* ç»¿è‰²æŒæ¡çŠ¶æ€ - è¦†ç›–åœ¨Front */
        .bubble.mastered .face-front { background: #D1FAE5; color: #065F46; border-color: #6EE7B7; }

        /* é€šç”¨ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(2px); }
        .modal { background: white; width: 90%; max-width: 450px; border-radius: 20px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(17, 24, 39, 0.95); color: white; padding: 10px 24px; border-radius: 30px; font-size: 14px; z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 500; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="drop-overlay" class="hidden" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(79,70,229,0.9);z-index:1000;color:white;display:flex;justify-content:center;align-items:center;flex-direction:column;">
        <div style="font-size:4rem;">ğŸ“‚</div>
        <h3>é‡Šæ”¾å¯¼å…¥</h3>
    </div>
    <div id="selection-marquee" style="position:fixed;border:1px solid #3b82f6;background:rgba(59,130,246,0.2);display:none;z-index:9999;pointer-events:none;"></div>

    <div id="bookshelf-view" class="view">
        <header>
            <div style="font-weight:800; font-size:18px;">ğŸ§  å•è¯è®­ç»ƒå™¨</div>
            <div class="header-actions" style="display: flex; gap: 8px;">
                <button class="btn btn-outline" onclick="FolderSys.createFolder()">ğŸ“‚ æ–°å»º</button>
                <button class="btn btn-ghost" onclick="SyncSys.exportData()">ğŸ“¤ å¤‡ä»½</button>
                <button class="btn btn-primary" onclick="App.showImportModal()">+ å¯¼å…¥</button>
            </div>
        </header>
        <div class="breadcrumb-bar" id="breadcrumb"></div>
        <div id="file-area" class="file-area" onmousedown="SelectionSys.start(event)">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <select id="sort-pref" onchange="App.savePref()">
                        <option value="random">ğŸ² éšæœºä¹±åº</option>
                        <option value="unmastered">âš¡ æœªæŒæ¡ä¼˜å…ˆ</option>
                    </select>
                </div>
                <div id="book-list" class="book-list"></div>
            </div>
        </div>
    </div>

    <div id="training-view" class="full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="App.endTraining()">âœ• é€€å‡º</button>
            <div class="header-center">
                <div id="train-book-title" class="header-title-text">è®­ç»ƒä¸­</div>
                <span style="font-size: 11px; color: var(--text-sub); white-space:nowrap;">
                    è½®æ¬¡ <span id="round-count">1</span> <span id="review-badge" class="hidden" style="color:#F59E0B;">(å¤ä¹ )</span>
                </span>
            </div>
            <div class="header-actions" style="display:flex; gap:5px;">
                <button class="btn btn-ghost" id="eye-btn" onclick="Training.toggleAllMeanings()">ğŸ‘ï¸</button>
                <button class="btn btn-ghost" onclick="Training.togglePause()">â¸</button>
            </div>
        </header>
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        <div id="card-container" class="training-container layout-grid"></div>
        <div style="padding: 12px; background: white; text-align: center; flex-shrink:0;">
             <button class="btn btn-outline" style="width: 200px;" onclick="Training.finishBatch()">ğŸ“¥ ç»“ç®— (Enter)</button>
        </div>
        <div id="pause-overlay" class="pause-overlay hidden">
            <h2>å·²æš‚åœ</h2>
            <button class="btn btn-primary" onclick="Training.togglePause()">ç»§ç»­</button>
        </div>
    </div>
    
    <div id="pool-view" class="full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="Pool.close()">â¬… è¿”å›</button> 
            <div class="header-center">
                <div class="header-title-text">é€Ÿç­›è¯æ± </div>
            </div>
            <div class="header-actions" style="width:32px;"></div> </header>
        <div id="pool-container" class="pool-container"></div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>å¯¼å…¥ / æ–°å»º</h3>
            <textarea id="import-text" style="width:100%; height:150px; border:1px solid #ddd; border-radius:8px; padding:10px; margin:10px 0;" placeholder="å•è¯ é‡Šä¹‰ (ä¸€è¡Œä¸€ä¸ª)"></textarea>
            <input type="text" id="import-name-input" placeholder="åç§°" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-ghost" onclick="document.getElementById('import-modal').classList.add('hidden')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="App.processImport()">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    <div id="toast">âœ… æ“ä½œæˆåŠŸ</div>

<script>
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    toast: (msg) => {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = 1; t.style.bottom = '40px';
        setTimeout(() => { t.style.opacity = 0; t.style.bottom = '30px'; }, 2000);
    },
    shuffle: (array) => array.sort(() => Math.random() - 0.5)
};

const StorageManager = {
    save: (id, val) => localStorage.setItem('bk_' + id, JSON.stringify(val)),
    get: (id) => { try { return JSON.parse(localStorage.getItem('bk_' + id)); } catch(e){ return null; } },
    remove: (id) => localStorage.removeItem('bk_' + id),
    getAll: () => {
        const items = [];
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('bk_')) items.push(JSON.parse(localStorage.getItem(k)));
        }
        return items;
    },
    initMistakeBook: () => {
        const all = StorageManager.getAll();
        if (!all.find(x => x.id === 'system_mistakes')) {
            StorageManager.save('system_mistakes', {
                id: 'system_mistakes', name: 'âŒ é”™é¢˜æœ¬', words: [], isSystem: true, type: 'book', parentId: 'root'
            });
        }
    }
};

const FolderSys = {
    currentId: 'root',
    path: [{id: 'root', name: 'æ ¹ç›®å½•'}],
    renderBreadcrumb: () => {
        const bc = document.getElementById('breadcrumb');
        bc.innerHTML = FolderSys.path.map((p, i) => 
            `<span class="crumb ${i===FolderSys.path.length-1?'active':''}" onclick="FolderSys.nav(${i})">${p.name}</span>`
        ).join('<span style="color:#ccc">></span>');
    },
    nav: (idx) => {
        FolderSys.path = FolderSys.path.slice(0, idx+1);
        FolderSys.currentId = FolderSys.path[idx].id;
        FolderSys.renderBreadcrumb();
        App.renderList();
    },
    createFolder: () => {
        const name = prompt("æ–‡ä»¶å¤¹åç§°");
        if(name) {
            const id = Utils.uuid();
            StorageManager.save(id, {id, name, type:'folder', parentId: FolderSys.currentId});
            App.renderList();
        }
    },
    enter: (id, name) => {
        FolderSys.path.push({id, name});
        FolderSys.currentId = id;
        FolderSys.renderBreadcrumb();
        App.renderList();
    }
};

const SelectionSys = {
    selectedIds: new Set(),
    isSelecting: false,
    startPos: {x:0, y:0},
    start: (e) => {
        if(e.target.closest('.item-card')) return;
        SelectionSys.isSelecting = true;
        SelectionSys.startPos = {x:e.pageX, y:e.pageY};
        SelectionSys.clear();
        document.addEventListener('mousemove', SelectionSys.move);
        document.addEventListener('mouseup', SelectionSys.end);
        document.getElementById('selection-marquee').style.display = 'block';
    },
    move: (e) => {
        if(!SelectionSys.isSelecting) return;
        const m = document.getElementById('selection-marquee');
        const w = Math.abs(e.pageX - SelectionSys.startPos.x);
        const h = Math.abs(e.pageY - SelectionSys.startPos.y);
        const l = Math.min(e.pageX, SelectionSys.startPos.x);
        const t = Math.min(e.pageY, SelectionSys.startPos.y);
        m.style.left = l+'px'; m.style.top = t+'px'; m.style.width = w+'px'; m.style.height = h+'px';
        document.querySelectorAll('.item-card').forEach(card => {
            const r = card.getBoundingClientRect();
            if(l < r.right && l+w > r.left && t < r.bottom && t+h > r.top) {
                SelectionSys.selectedIds.add(card.dataset.id);
                card.classList.add('selected');
            }
        });
    },
    end: () => {
        SelectionSys.isSelecting = false;
        document.removeEventListener('mousemove', SelectionSys.move);
        document.removeEventListener('mouseup', SelectionSys.end);
        document.getElementById('selection-marquee').style.display = 'none';
    },
    clear: () => {
        SelectionSys.selectedIds.clear();
        document.querySelectorAll('.item-card.selected').forEach(e=>e.classList.remove('selected'));
    }
};

const App = {
    init: () => {
        StorageManager.initMistakeBook();
        FolderSys.renderBreadcrumb();
        App.renderList();
    },
    renderList: () => {
        const list = document.getElementById('book-list');
        list.innerHTML = '';
        const items = StorageManager.getAll().filter(x => x.parentId === FolderSys.currentId);
        items.sort((a,b) => (a.type==='folder' ? -1 : 1));
        if(items.length === 0) list.innerHTML = '<div style="color:#999;grid-column:1/-1;text-align:center;padding:20px;">ç©ºç©ºå¦‚ä¹Ÿ</div>';
        items.forEach(item => {
            const el = document.createElement('div');
            el.className = `item-card ${SelectionSys.selectedIds.has(item.id)?'selected':''}`;
            el.dataset.id = item.id;
            const icon = item.type === 'folder' ? 'ğŸ“' : (item.id==='system_mistakes' ? 'ğŸ“•' : 'ğŸ“˜');
            const meta = item.type === 'book' ? `<div class="item-meta">${item.words.length} è¯</div>` : '';
            el.innerHTML = `
                <div class="item-icon">${icon}</div>
                <div class="item-name">${item.name}</div>
                ${meta}
                <div class="item-actions-row">
                    ${item.type==='book' ? `<button class="btn btn-ghost btn-icon" onclick="event.stopPropagation();App.deleteItem('${item.id}')">ğŸ—‘</button>` : ''}
                    ${item.type==='book' && !item.isSystem ? `<button class="btn btn-ghost btn-icon" onclick="event.stopPropagation();Pool.start('${item.id}')">ğŸŒŠ</button>` : ''}
                </div>
            `;
            el.onclick = () => {
                if(item.type === 'folder') FolderSys.enter(item.id, item.name);
                else Training.start(item.id);
            };
            list.appendChild(el);
        });
    },
    processImport: () => {
        const text = document.getElementById('import-text').value;
        const name = document.getElementById('import-name-input').value || 'æ–°å•è¯æœ¬';
        if(!text) return;
        const words = text.split('\n').filter(l=>l.trim()).map(l => {
            const parts = l.trim().split(/\s+/);
            return { id: Utils.uuid(), word: parts[0], meaning: parts.slice(1).join(' '), status: 0 };
        });
        const id = Utils.uuid();
        StorageManager.save(id, {id, name, type:'book', words, parentId: FolderSys.currentId});
        document.getElementById('import-modal').classList.add('hidden');
        App.renderList();
    },
    showImportModal: () => document.getElementById('import-modal').classList.remove('hidden'),
    endTraining: () => {
        clearInterval(Training.timer);
        document.getElementById('training-view').classList.add('hidden');
        document.getElementById('bookshelf-view').classList.remove('hidden');
        App.renderList();
    },
    deleteItem: (id) => {
        if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { StorageManager.remove(id); App.renderList(); }
    },
    savePref: () => { /* é¢„ç•™ */ }
};

const Training = {
    queue: [], current: [], round: 0, currentBookId: null, timer: null, timeLeft: 60, isPaused: false,
    
    start: (id) => {
        const book = StorageManager.get(id);
        const pending = book.words.filter(w => w.status !== 2);
        if(!pending.length && book.words.length > 0) { Utils.toast('å…¨ä¹¦å·²æŒæ¡ï¼'); return; }
        if(book.words.length === 0) { Utils.toast('ç©ºä¹¦'); return; }
        
        Training.currentBookId = id;
        Training.queue = pending; 
        Utils.shuffle(Training.queue);
        
        Training.round = 0;
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('training-view').classList.remove('hidden');
        document.getElementById('train-book-title').innerText = book.name;
        document.getElementById('card-container').classList.remove('show-all-meanings');
        Training.next();
    },
    
    next: () => {
        Training.round++;
        document.getElementById('round-count').innerText = Training.round;
        
        let batch = [];
        const isReview = (Training.round % 3 === 0);
        
        if (isReview) {
            const mistakeBook = StorageManager.get('system_mistakes');
            const oldMistakes = mistakeBook.words.filter(w => w.status !== 2);
            Utils.shuffle(oldMistakes);
            const picks = oldMistakes.slice(0, 2);
            if(picks.length > 0) {
                document.getElementById('review-badge').classList.remove('hidden');
                const newOnes = Training.queue.splice(0, 8 - picks.length);
                batch = [...picks, ...newOnes];
            } else {
                batch = Training.queue.splice(0, 8);
                document.getElementById('review-badge').classList.add('hidden');
            }
        } else {
            document.getElementById('review-badge').classList.add('hidden');
            batch = Training.queue.splice(0, 8);
        }

        const map = new Map();
        batch.forEach(w => map.set(w.word, w));
        batch = Array.from(map.values());

        if (batch.length === 0) {
            alert('æœ¬è½®è®­ç»ƒå®Œæˆï¼');
            App.endTraining();
            return;
        }

        Training.current = batch.map(w => ({...w, tempState: 0 })); 
        Training.render();
        Training.startTimer();
    },

    render: () => {
        const c = document.getElementById('card-container');
        c.innerHTML = '';
        c.style.setProperty('--cols', Math.ceil(Training.current.length / 2));
        
        Training.current.forEach(w => {
            const el = document.createElement('div');
            const stateClass = w.tempState === 1 ? 'state-red' : (w.tempState === 2 ? 'state-green' : 'state-white');
            
            el.className = `word-card ${stateClass}`;
            el.id = 'card-' + w.id;
            
            el.innerHTML = `
                <div class="card-inner">
                    <div class="card-front">
                        <div class="check-mark">âœ…</div>
                        <div class="section-top">
                            <div class="word-text">${w.word}</div>
                        </div>
                        <div class="section-bottom">
                            <div class="word-meaning">${w.meaning}</div>
                        </div>
                    </div>
                    <div class="card-back">
                        <div class="section-top">
                            <div class="word-text">${w.word}</div>
                        </div>
                        <div class="section-bottom">
                            <div class="word-meaning">${w.meaning}</div>
                        </div>
                    </div>
                </div>
            `;
            el.onclick = (event) => Training.handleCardClick(w, event);
            c.appendChild(el);
        });
    },

    handleCardClick: (w, event) => {
        // **ä¿®å¤å°è¯•ï¼šé˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º**
        if (event) {
            // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå°¤å…¶æ˜¯æµè§ˆå™¨å°è¯•æ»šåŠ¨åˆ°ç„¦ç‚¹æˆ–å¼¹å‡ºåœ°å€æ çš„è¡Œä¸º
            event.preventDefault(); 
            // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¯èƒ½è§¦å‘æ»šåŠ¨æˆ–æŠ–åŠ¨çš„çˆ¶å…ƒç´ 
            event.stopPropagation();
        }

        if (Training.isPaused) return;

        let nextState;
        if (w.tempState === 0) nextState = 1;
        else if (w.tempState === 1) nextState = 2;
        else if (w.tempState === 2) nextState = 1;

        w.tempState = nextState;
        
        const el = document.getElementById('card-' + w.id);
        el.className = `word-card ${nextState === 1 ? 'state-red' : (nextState === 2 ? 'state-green' : 'state-white')}`;

        if (Training.current.every(x => x.tempState === 2)) {
            setTimeout(Training.finishBatch, 600);
        }
    },

    toggleAllMeanings: () => {
        document.getElementById('card-container').classList.toggle('show-all-meanings');
    },

    finishBatch: () => {
        const bookId = Training.currentBookId;
        const mistakes = [];
        Training.current.forEach(w => {
            const finalStatus = w.tempState === 2 ? 2 : 0; 
            StorageManager.updateStatus(bookId, w.id, finalStatus);
            if (finalStatus !== 2) {
                mistakes.push(w);
                if (!Training.queue.find(q => q.word === w.word)) Training.queue.push(w);
            }
        });

        if (mistakes.length > 0) {
            const mb = StorageManager.get('system_mistakes');
            mistakes.forEach(mw => {
                if (!mb.words.find(exist => exist.word === mw.word)) {
                    mb.words.unshift({ ...mw, id: Utils.uuid(), status: 0 });
                }
            });
            StorageManager.save('system_mistakes', mb);
            Utils.toast(`${mistakes.length} ä¸ªå­˜å…¥é”™é¢˜æœ¬`);
        } else {
            Utils.toast('æœ¬è½®å…¨å¯¹ï¼');
        }
        Training.next();
    },

    startTimer: () => {
        clearInterval(Training.timer);
        Training.timeLeft = 60;
        const bar = document.getElementById('timer-progress');
        bar.style.transition = 'none'; bar.style.width = '100%'; bar.offsetHeight; 
        bar.style.transition = 'width 1s linear';
        Training.timer = setInterval(() => {
            if(Training.isPaused) return;
            Training.timeLeft--;
            bar.style.width = (Training.timeLeft/60)*100 + '%';
            if(Training.timeLeft <= 0) Training.finishBatch();
        }, 1000);
    },
    
    togglePause: () => {
        Training.isPaused = !Training.isPaused;
        const overlay = document.getElementById('pause-overlay');
        overlay.classList.toggle('hidden');
    }
};

StorageManager.updateStatus = (bookId, wordId, status) => {
    const book = StorageManager.get(bookId);
    if(book) {
        let target = book.words.find(w => w.id === wordId);
        if (target) {
            target.status = status;
            StorageManager.save(bookId, book);
        }
        const mb = StorageManager.get('system_mistakes');
        const mTarget = mb.words.find(w => w.word === (target ? target.word : ''));
        if (mTarget) {
            mTarget.status = status;
            StorageManager.save('system_mistakes', mb);
        }
    }
};

const Pool = {
    close: () => {
        // æ¸…é™¤æ‰€æœ‰æœªæ‰§è¡Œçš„è®¡æ—¶å™¨
        document.querySelectorAll('.bubble').forEach(el => {
            if (el.revertTimer) clearTimeout(el.revertTimer);
            if (el.vanishTimer) clearTimeout(el.vanishTimer);
        });

        document.getElementById('pool-view').classList.add('hidden');
        document.getElementById('bookshelf-view').classList.remove('hidden');
    },
    start: (bookId) => {
        Pool.bookId = bookId;
        const book = StorageManager.get(bookId);
        const words = book.words.filter(w => w.status !== 2);
        if(!words.length) { Utils.toast("å…¨ä¹¦å·²æŒæ¡"); return; }
        
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('pool-view').classList.remove('hidden');
        const c = document.getElementById('pool-container');
        c.innerHTML = '';
        Utils.shuffle(words).forEach(w => {
            const el = document.createElement('div');
            el.className = 'bubble';
            el.innerHTML = `<div class="bubble-face face-front">${w.word}</div><div class="bubble-face face-back">${w.meaning}</div>`;
            
            el.revertTimer = null; 
            el.vanishTimer = null;

            el.onclick = (event) => {
                // **ä¿®å¤å°è¯•ï¼šé˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º**
                if (event) {
                    event.preventDefault(); 
                    event.stopPropagation();
                }

                if(el.classList.contains('vanish')) return;

                // 1. æ¯æ¬¡ç‚¹å‡»éƒ½æ¸…é™¤å½“å‰æ°”æ³¡çš„è®¡æ—¶å™¨
                if (el.revertTimer) {
                    clearTimeout(el.revertTimer);
                    el.revertTimer = null;
                }
                if (el.vanishTimer) {
                    clearTimeout(el.vanishTimer);
                    el.vanishTimer = null;
                }

                // çŠ¶æ€2(ç»¿/Mastered) -> çŠ¶æ€1(Blue/Flipped/Meaning) [åæ‚”/å›çœ‹]
                if(el.classList.contains('mastered')) {
                    el.classList.remove('mastered');
                    el.classList.add('flipped'); 
                    
                    // å¼€å¯ 5 ç§’è‡ªåŠ¨å›å¼¹è®¡æ—¶å™¨
                    el.revertTimer = setTimeout(() => {
                        el.classList.remove('flipped'); // è‡ªåŠ¨ç¿»å›æ­£é¢
                        el.revertTimer = null;
                    }, 5000);

                    return;
                }
                
                // çŠ¶æ€1(Flipped/Meaning) -> çŠ¶æ€2(Green/Word) [æŒæ¡]
                if(el.classList.contains('flipped')) {
                    el.classList.remove('flipped'); // ç¿»å›æ­£é¢(0deg)
                    el.classList.add('mastered');   // å˜ç»¿
                    
                    // å¼€å¯ 3 ç§’æ¶ˆå¤±è®¡æ—¶å™¨
                    el.vanishTimer = setTimeout(() => {
                        el.classList.add('vanish');
                        StorageManager.updateStatus(Pool.bookId, w.id, 2);
                    }, 3000);
                    return;
                }

                // çŠ¶æ€0(White/Word) -> çŠ¶æ€1(Flipped/Meaning) [æŸ¥çœ‹]
                el.classList.add('flipped'); // ç¿»åˆ°èƒŒé¢(180deg)

                // å¼€å¯ 5 ç§’è‡ªåŠ¨å›å¼¹è®¡æ—¶å™¨
                el.revertTimer = setTimeout(() => {
                    el.classList.remove('flipped'); // è‡ªåŠ¨ç¿»å›æ­£é¢
                    el.revertTimer = null;
                }, 5000);
            };
            c.appendChild(el);
        });
    }
};

const SyncSys = {
    exportData: () => {
        const d = {};
        StorageManager.getAll().forEach(i => d['bk_'+i.id] = i);
        const b = new Blob([JSON.stringify(d)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click();
    }
};

window.onload = App.init;
</script>
</body>
</html>
