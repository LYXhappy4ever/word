<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜»æ–­å¼å•è¯è®­ç»ƒå™¨ (ç»ˆæç‰ˆ)</title>
    <style>
        :root {
            --primary: #4F46E5; /* Indigo 600 */
            --primary-dark: #4338ca;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --success: #10B981;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font-stack); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* é€šç”¨ç»„ä»¶ */
        .btn {
            border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-outline { border: 1px solid #d1d5db; background: white; color: var(--text-main); }
        
        .hidden { display: none !important; }
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--bg-body); display: flex; flex-direction: column; }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-sm); z-index: 50; flex-shrink: 0;
        }
        header h1 { margin: 0; font-size: 18px; font-weight: 700; color: var(--primary); }

        /* ä¹¦æ¶è§†å›¾ */
        #bookshelf-view { flex: 1; overflow-y: auto; padding: 16px; }
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; }
        .book-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 16px;
            box-shadow: var(--shadow-sm); position: relative; transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.02);
            display: flex; flex-direction: column; justify-content: space-between; height: 140px;
        }
        .book-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .book-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .book-meta { font-size: 12px; color: var(--text-sub); margin-bottom: 8px; }
        .book-special { border: 2px solid var(--danger); }
        .book-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: auto; }
        .add-book-card {
            border: 2px dashed #d1d5db; background: transparent; color: var(--text-sub);
            align-items: center; justify-content: center; cursor: pointer;
        }
        
        /* è®­ç»ƒè§†å›¾ */
        #training-view { display: flex; flex-direction: column; height: 100%; }
        .training-header { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; background: white; }
        .timer-bar { height: 4px; background: #e5e7eb; width: 100%; position: relative; }
        .timer-progress { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        
        .training-container { flex: 1; overflow-y: auto; padding: 16px; position: relative; }
        
        /* å¸ƒå±€æ¨¡å¼: ç½‘æ ¼ (é»˜è®¤) */
        .layout-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            align-content: start;
        }
        @media (min-width: 600px) { .layout-grid { grid-template-columns: repeat(4, 1fr); } }

        /* å¸ƒå±€æ¨¡å¼: å•åˆ— */
        .layout-list { display: flex; flex-direction: column; gap: 16px; max-width: 600px; margin: 0 auto; }
        .layout-list .word-card { height: 200px; font-size: 1.2em; }

        /* å¡ç‰‡ç¿»è½¬æ ¸å¿ƒ */
        .word-card {
            background: transparent; perspective: 1000px; height: 140px; cursor: pointer;
            position: relative; user-select: none;
        }
        .card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; border-radius: var(--radius);
            box-shadow: var(--shadow-md); will-change: transform;
        }
        .word-card.flipped .card-inner { transform: rotateY(180deg); }
        .word-card.completed { opacity: 0; pointer-events: none; transition: opacity 0.5s; } /* æé€Ÿæ¨¡å¼æ¶ˆå¤± */

        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: white; border-radius: var(--radius); padding: 10px;
        }
        .card-back { transform: rotateY(180deg); background: #fafafa; }
        
        .word-text { font-size: 18px; font-weight: 700; color: var(--text-main); word-break: break-all; }
        .word-meaning { font-size: 14px; color: var(--text-sub); margin-bottom: 10px; overflow-y: auto; max-height: 60px; }
        
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; position: absolute; top: 10px; right: 10px;
            background: #d1d5db;
        }
        .status-dot.green { background: var(--success); }
        .status-dot.red { background: var(--danger); }
        
        .review-tag {
            position: absolute; top: 8px; left: 8px; font-size: 10px; background: #FEF3C7; color: #D97706;
            padding: 2px 6px; border-radius: 4px; font-weight: bold;
        }

        .card-actions { display: flex; gap: 8px; width: 100%; margin-top: auto; }
        .action-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; }
        .btn-remember { background: var(--success); }
        .btn-forgot { background: var(--danger); }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-controls {
            padding: 12px 16px; background: white; border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* å¯¼å…¥å¼¹çª— */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; z-index: 200;
        }
        .modal { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow-lg); }
        textarea { width: 100%; height: 100px; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px; margin: 10px 0; font-family: monospace; resize: none; }
        
        /* æç¤ºä¿¡æ¯ */
        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.9); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 300;
        }
    </style>
</head>
<body>

    <div id="bookshelf-view" class="view">
        <header>
            <h1>ğŸ“š æˆ‘çš„ä¹¦æ¶</h1>
            <button class="btn btn-primary" onclick="App.showImportModal()">+ å¯¼å…¥</button>
        </header>
        <div id="book-list" class="book-list"></div>
        <div style="margin-top: 20px; text-align: center; color: #9ca3af; font-size: 12px;">
            å­˜å‚¨çŠ¶æ€: <span id="storage-status">Checking...</span>
        </div>
    </div>

    <div id="training-view" class="view full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="App.endTraining()">é€€å‡º</button>
            <div style="text-align: center;">
                <h1 id="train-book-title">è®­ç»ƒä¸­</h1>
                <span style="font-size: 10px; color: var(--text-sub)">ç¬¬ <span id="round-count">1</span> è½® | ç»„å‰©ä½™: <span id="group-remain">0</span></span>
            </div>
            <button class="btn btn-ghost" style="color: var(--primary)" onclick="Training.forceNextGroup()">è·³è¿‡</button>
        </header>
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        
        <div id="card-container" class="training-container layout-grid">
            </div>

        <div class="bottom-controls">
            <button class="btn btn-outline" id="layout-toggle" onclick="Training.toggleLayout()">âŠ åˆ‡æ¢è§†å›¾</button>
            <span style="font-size: 12px; color: var(--text-sub)">ç‚¹å‡»å¡ç‰‡ç¿»é¢</span>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>å¯¼å…¥å•è¯ä¹¦</h3>
            <p style="font-size: 12px; color: gray;">æ”¯æŒ JSON æˆ– ç²˜è´´æ–‡æœ¬ (è‡ªåŠ¨æ­£åˆ™æŠ“å–)</p>
            <input type="text" id="import-name" placeholder="ä¹¦å (å¯é€‰)" style="width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <textarea id="import-content" placeholder='ç²˜è´´å†…å®¹... ä¾‹å¦‚: [{"word":"apple","meaning":"è‹¹æœ"}]'></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-ghost" onclick="document.getElementById('import-modal').classList.add('hidden')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="App.processImport()">å¼€å§‹å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

<script>
/**
 * 1. æ ¸å¿ƒæœåŠ¡ï¼šéŸ³é¢‘ã€å­˜å‚¨ã€å·¥å…·
 */
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    toast: (msg) => {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    },
    // æš´åŠ›æ­£åˆ™æå–å•è¯
    extractWords: (text) => {
        const words = [];
        // åŒ¹é…æ¨¡å¼1: JSON-like key:value
        const regexJSON = /word["']?\s*:\s*["'](.*?)["'][\s\S]*?meaning["']?\s*:\s*["'](.*?)["']/gi;
        // åŒ¹é…æ¨¡å¼2: ç®€å•è¡Œ word ... meaning (å…œåº•)
        let match;
        while ((match = regexJSON.exec(text)) !== null) {
            if(match[1] && match[2]) words.push({ word: match[1], meaning: match[2], id: Utils.uuid() });
        }
        if (words.length === 0) {
            // å°è¯•æ›´æš´åŠ›çš„å•è¡Œåˆ†å‰²
            const lines = text.split('\n');
            lines.forEach(line => {
                const parts = line.split(/[\t,:-]+/); // å°è¯•å¸¸è§åˆ†éš”ç¬¦
                if(parts.length >= 2 && parts[0].length > 1) {
                    words.push({ word: parts[0].trim(), meaning: parts.slice(1).join(' ').trim(), id: Utils.uuid() });
                }
            });
        }
        return words;
    }
};

const AudioSys = {
    ctx: null,
    init: () => {
        if (!AudioSys.ctx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            AudioSys.ctx = new AudioContext();
        }
    },
    beep: () => {
        if (!AudioSys.ctx) return;
        if (AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
        const osc = AudioSys.ctx.createOscillator();
        const gain = AudioSys.ctx.createGain();
        osc.connect(gain);
        gain.connect(AudioSys.ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, AudioSys.ctx.currentTime); // A5
        osc.frequency.exponentialRampToValueAtTime(440, AudioSys.ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, AudioSys.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime + 0.1);
        osc.start();
        osc.stop(AudioSys.ctx.currentTime + 0.15);
    }
};

const StorageSys = {
    mode: 'local', // 'local' or 'ram'
    ramCache: {},
    init: () => {
        try {
            localStorage.setItem('__test', '1');
            localStorage.removeItem('__test');
            StorageSys.mode = 'local';
            document.getElementById('storage-status').innerText = 'æ­£å¸¸ (Disk)';
        } catch (e) {
            StorageSys.mode = 'ram';
            document.getElementById('storage-status').innerText = 'é™çº§æ¨¡å¼ (RAM - åˆ·æ–°ä¸¢å¤±)';
            Utils.toast('âš ï¸ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²åˆ‡æ¢ä¸ºä¸´æ—¶å†…å­˜æ¨¡å¼');
        }
        // åˆå§‹åŒ–é”™é¢˜æœ¬
        if (!StorageSys.getBook(App.MISTAKE_BOOK_ID)) {
            StorageSys.saveBook({
                id: App.MISTAKE_BOOK_ID,
                name: 'ğŸ“… é”™é¢˜æœ¬',
                words: [],
                isSystem: true
            });
        }
    },
    getBooksMeta: () => {
        if (StorageSys.mode === 'ram') return Object.values(StorageSys.ramCache).map(b => ({id: b.id, name: b.name, count: b.words.length, isSystem: b.isSystem}));
        
        const books = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('bk_')) {
                try {
                    const b = JSON.parse(localStorage.getItem(key));
                    books.push({ id: b.id, name: b.name, count: b.words.length, isSystem: b.isSystem });
                } catch(e) {}
            }
        }
        return books.sort((a,b) => b.isSystem ? 1 : -1); // é”™é¢˜æœ¬ç½®é¡¶
    },
    getBook: (id) => {
        if (StorageSys.mode === 'ram') return StorageSys.ramCache[id];
        return JSON.parse(localStorage.getItem('bk_' + id));
    },
    saveBook: (book) => {
        try {
            if (StorageSys.mode === 'local') {
                localStorage.setItem('bk_' + book.id, JSON.stringify(book));
            } else {
                StorageSys.ramCache[book.id] = book;
            }
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                StorageSys.mode = 'ram';
                StorageSys.ramCache[book.id] = book; // é™çº§å†™å…¥
                Utils.toast('å­˜å‚¨å·²æ»¡ï¼Œè½¬å…¥å†…å­˜æ¨¡å¼');
                document.getElementById('storage-status').innerText = 'é™çº§æ¨¡å¼ (RAM)';
            }
        }
    },
    deleteBook: (id) => {
        if (StorageSys.mode === 'local') localStorage.removeItem('bk_' + id);
        else delete StorageSys.ramCache[id];
    },
    addToMistakes: (wordObj) => {
        const mb = StorageSys.getBook(App.MISTAKE_BOOK_ID);
        // å»é‡
        if (!mb.words.find(w => w.word === wordObj.word)) {
            mb.words.unshift({ ...wordObj, id: Utils.uuid() }); // å¤åˆ¶å¹¶èµ‹äºˆæ–°ID
            StorageSys.saveBook(mb);
        }
    }
};

/**
 * 2. è®­ç»ƒé€»è¾‘å¼•æ“
 */
const Training = {
    currentBook: null,
    queue: [],         // å¾…è®­ç»ƒé˜Ÿåˆ—
    currentGroup: [],  // å½“å‰å±•ç¤ºç»„
    mistakesBuffer: [],// å½“å‰è®­ç»ƒçš„é”™é¢˜ç¼“å­˜ï¼ˆå›é©¬æªç”¨ï¼‰
    timer: null,
    timeLeft: 60,
    roundsCompleted: 0,
    layout: 'grid',    // grid | list
    
    start: (bookId) => {
        Training.currentBook = StorageSys.getBook(bookId);
        if (!Training.currentBook || Training.currentBook.words.length === 0) {
            Utils.toast('è¿™æœ¬ä¹¦æ˜¯ç©ºçš„ï¼');
            return;
        }
        
        // ç®€å•çš„æ´—ç‰Œ
        let words = [...Training.currentBook.words].sort(() => 0.5 - Math.random());
        Training.queue = words;
        Training.mistakesBuffer = [];
        Training.roundsCompleted = 0;
        
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('training-view').classList.remove('hidden');
        document.getElementById('train-book-title').innerText = Training.currentBook.name;
        
        // æ¢å¤å¸ƒå±€åå¥½
        const savedLayout = localStorage.getItem('layout_pref');
        if(savedLayout) Training.setLayout(savedLayout);

        AudioSys.init();
        Training.nextGroup();
    },
    
    nextGroup: () => {
        // æ¸…é™¤æ—§è®¡æ—¶å™¨
        clearInterval(Training.timer);
        AudioSys.beep();
        Training.roundsCompleted++;
        
        // 1. åŸºç¡€æŠ½å–
        const GROUP_SIZE = 8;
        let nextBatch = Training.queue.splice(0, GROUP_SIZE);
        
        // 2. åŒè½¨å›é©¬æªé€»è¾‘ (æ¯3è½®ï¼Œå¦‚æœç¼“å†²åŒºæœ‰é”™è¯ï¼Œæ³¨å…¥2ä¸ª)
        if (Training.roundsCompleted % 3 === 0 && Training.mistakesBuffer.length > 0) {
            const injections = Training.mistakesBuffer.splice(0, 2);
            injections.forEach(w => w.isReview = true); // æ ‡è®°ä¸ºå¤ä¹ 
            nextBatch = nextBatch.concat(injections);
        }
        
        if (nextBatch.length === 0) {
            if (Training.mistakesBuffer.length > 0) {
                // é˜Ÿåˆ—ç©ºäº†ä½†è¿˜æœ‰é”™è¯ï¼Œå…¨éƒ¨å€’å›å»ç»§ç»­ç»ƒ
                Training.queue = Training.mistakesBuffer;
                Training.mistakesBuffer = [];
                Training.nextGroup();
                return;
            } else {
                alert('ğŸ‰ è®­ç»ƒå®Œæˆï¼å¤ªæ£’äº†ï¼');
                App.endTraining();
                return;
            }
        }

        Training.currentGroup = nextBatch.map(w => ({ ...w, status: 'pending' })); // pending, remembered, forgot
        Training.renderCards();
        Training.startTimer();
        Training.updateStats();
    },

    startTimer: () => {
        Training.timeLeft = 60; // 60ç§’
        const bar = document.getElementById('timer-progress');
        bar.style.transition = 'none';
        bar.style.width = '100%';
        
        // å¼ºåˆ¶é‡ç»˜
        bar.offsetHeight; 
        
        bar.style.transition = 'width 1s linear';
        
        Training.timer = setInterval(() => {
            Training.timeLeft--;
            const pct = (Training.timeLeft / 60) * 100;
            bar.style.width = `${pct}%`;
            
            if (Training.timeLeft <= 0) {
                Training.forceNextGroup();
            }
        }, 1000);
    },

    forceNextGroup: () => {
        // æ—¶é—´åˆ°ï¼Œè¿˜æ²¡è®°çš„è¯ç®—ä½œ "Forgot" ä½†ä¸åŠ å…¥é”™é¢˜æœ¬ï¼ŒåªåŠ å…¥å›é©¬æª? 
        // ç­–ç•¥ï¼šæœªæ ‡è®°çš„å…¨éƒ¨è§†ä¸º "Forgot" å¹¶ä¿ç•™åœ¨å½“å‰è®­ç»ƒå‘¨æœŸçš„æœ«å°¾(Queue)ï¼Œä¸è®°å…¥æ°¸ä¹…é”™é¢˜æœ¬ä»¥å…æ±¡æŸ“
        const pending = Training.currentGroup.filter(w => w.status === 'pending');
        if (pending.length > 0) {
            // å°†æœªå®Œæˆçš„è¯å¡å›é˜Ÿåˆ—æœ«å°¾
            Training.queue.push(...pending);
            Utils.toast(`${pending.length} ä¸ªå•è¯æœªå®Œæˆï¼Œå·²æ¨å`);
        }
        Training.nextGroup();
    },

    handleCardAction: (id, action) => {
        const idx = Training.currentGroup.findIndex(w => w.id === id);
        if (idx === -1) return;
        const item = Training.currentGroup[idx];
        
        // æ›´æ–°UIçŠ¶æ€
        const cardEl = document.getElementById(`card-${id}`);
        const dot = cardEl.querySelector('.status-dot');
        
        if (action === 'remember') {
            item.status = 'remembered';
            dot.className = 'status-dot green';
            // ç¿»è½¬å›æ¥
            cardEl.classList.remove('flipped');
        } else {
            item.status = 'forgot';
            dot.className = 'status-dot red';
            cardEl.classList.remove('flipped');
            
            // æ ¸å¿ƒé€»è¾‘ï¼šåŒè½¨
            // è½¨1: åŠ å…¥æœ¬å±€å›é©¬æª
            Training.mistakesBuffer.push(item);
            // è½¨2: å­˜å…¥æ°¸ä¹…é”™é¢˜æœ¬
            StorageSys.addToMistakes(item);
        }
        
        // æé€Ÿæ¨¡å¼æ£€æµ‹
        const allDone = Training.currentGroup.every(w => w.status === 'remembered');
        if (allDone) {
            setTimeout(Training.nextGroup, 500); // ç¨å¾®å»¶è¿Ÿä½“éªŒæ›´å¥½
        }
    },

    renderCards: () => {
        const container = document.getElementById('card-container');
        container.innerHTML = '';
        
        Training.currentGroup.forEach(item => {
            const el = document.createElement('div');
            el.className = 'word-card';
            el.id = `card-${item.id}`;
            el.onclick = (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸ç¿»è½¬
                if (e.target.tagName === 'BUTTON') return;
                el.classList.toggle('flipped');
            };
            
            const reviewTag = item.isReview ? `<div class="review-tag">å¤ä¹ </div>` : '';
            
            el.innerHTML = `
                <div class="card-inner">
                    <div class="card-front">
                        ${reviewTag}
                        <div class="status-dot"></div>
                        <div class="word-text">${item.word}</div>
                    </div>
                    <div class="card-back">
                        <div class="word-meaning">${item.meaning}</div>
                        <div class="card-actions">
                            <button class="action-btn btn-forgot" onclick="Training.handleCardAction('${item.id}', 'forgot')">æ²¡è®°ä½</button>
                            <button class="action-btn btn-remember" onclick="Training.handleCardAction('${item.id}', 'remember')">è®°ä½äº†</button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(el);
        });
    },

    updateStats: () => {
        document.getElementById('round-count').innerText = Training.roundsCompleted;
        document.getElementById('group-remain').innerText = Training.currentGroup.length;
    },

    toggleLayout: () => {
        const newLayout = Training.layout === 'grid' ? 'list' : 'grid';
        Training.setLayout(newLayout);
    },
    
    setLayout: (mode) => {
        Training.layout = mode;
        const container = document.getElementById('card-container');
        const btn = document.getElementById('layout-toggle');
        
        if (mode === 'grid') {
            container.classList.remove('layout-list');
            container.classList.add('layout-grid');
            btn.innerText = 'âŠ åˆ‡æ¢è§†å›¾';
        } else {
            container.classList.remove('layout-grid');
            container.classList.add('layout-list');
            btn.innerText = 'â–¢ åˆ‡æ¢è§†å›¾';
        }
        localStorage.setItem('layout_pref', mode);
    }
};

/**
 * 3. åº”ç”¨ä¸»æ§
 */
const App = {
    MISTAKE_BOOK_ID: 'mistake_notebook',
    
    init: () => {
        StorageSys.init();
        App.renderBookshelf();
    },

    renderBookshelf: () => {
        const list = document.getElementById('book-list');
        list.innerHTML = '';
        const books = StorageSys.getBooksMeta();
        
        books.forEach(b => {
            const el = document.createElement('div');
            el.className = `book-card ${b.isSystem ? 'book-special' : ''}`;
            el.innerHTML = `
                <div>
                    <div class="book-title">${b.name}</div>
                    <div class="book-meta">${b.count} è¯</div>
                </div>
                <div class="book-actions">
                    ${!b.isSystem ? `<button class="btn btn-outline" style="padding:4px 8px; font-size:12px;" onclick="App.deleteBook('${b.id}', event)">åˆ </button>` : ''}
                    <button class="btn btn-primary" onclick="Training.start('${b.id}')">è¿›å…¥</button>
                </div>
            `;
            list.appendChild(el);
        });

        // æ·»åŠ æŒ‰é’®
        const addBtn = document.createElement('div');
        addBtn.className = 'book-card add-book-card';
        addBtn.innerHTML = '<div style="font-size:32px;">+</div><div>å¯¼å…¥ä¹¦æœ¬</div>';
        addBtn.onclick = App.showImportModal;
        list.appendChild(addBtn);
    },

    showImportModal: () => {
        document.getElementById('import-modal').classList.remove('hidden');
        document.getElementById('import-content').value = '';
        document.getElementById('import-name').value = '';
    },

    processImport: () => {
        const raw = document.getElementById('import-content').value;
        const nameInput = document.getElementById('import-name').value;
        if (!raw.trim()) return;

        let words = [];
        let bookName = nameInput || 'æ–°å•è¯ä¹¦ ' + new Date().toLocaleDateString();

        try {
            // å°è¯•æ ‡å‡† JSON
            const json = JSON.parse(raw);
            if (Array.isArray(json)) {
                words = json.map(w => ({word: w.word, meaning: w.meaning, id: Utils.uuid()}));
            } else if (json.fullContent) {
                // å…¼å®¹ç‰¹å®šæ ¼å¼
                words = json.fullContent.map(w => ({word: w.word, meaning: w.meaning, id: Utils.uuid()}));
                if (!nameInput && json.fileName) bookName = json.fileName;
            }
        } catch (e) {
            // JSON å¤±è´¥ï¼Œæ­£åˆ™æå–
            console.log('JSON Parse failed, using regex fallback');
        }

        if (words.length === 0) {
            words = Utils.extractWords(raw);
        }

        if (words.length === 0) {
            alert('æ— æ³•è§£æå†…å®¹ã€‚è¯·æ£€æŸ¥æ ¼å¼ã€‚\næ”¯æŒ JSON æˆ– "å•è¯: é‡Šä¹‰" æ–‡æœ¬ã€‚');
            return;
        }

        const newBook = {
            id: Utils.uuid(),
            name: bookName,
            words: words,
            isSystem: false
        };

        StorageSys.saveBook(newBook);
        document.getElementById('import-modal').classList.add('hidden');
        App.renderBookshelf();
        Utils.toast(`æˆåŠŸå¯¼å…¥ ${words.length} ä¸ªå•è¯`);
    },

    deleteBook: (id, e) => {
        e.stopPropagation();
        if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ')) {
            StorageSys.deleteBook(id);
            App.renderBookshelf();
        }
    },

    endTraining: () => {
        clearInterval(Training.timer);
        document.getElementById('training-view').classList.add('hidden');
        document.getElementById('bookshelf-view').classList.remove('hidden');
        App.renderBookshelf(); // åˆ·æ–°æ•°æ®ï¼ˆå°¤å…¶æ˜¯é”™é¢˜æœ¬æ•°é‡å˜åŒ–ï¼‰
    }
};

// å¯åŠ¨
window.onload = App.init;
</script>
</body>
</html>