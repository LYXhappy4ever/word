<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜»æ–­å¼å•è¯è®­ç»ƒå™¨ (å¼ºåŠ›æ¢å¤ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4F46E5;
            --bg-body: #F9FAFB;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --success: #10B981;
            --radius: 16px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font-stack); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .btn { border: none; padding: 12px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; font-size: 15px; display: inline-flex; align-items: center; justify-content: center; touch-action: manipulation; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-outline { border: 1px solid #d1d5db; background: white; color: var(--text-main); }
        
        .hidden { display: none !important; }
        .view { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        header { background: rgba(255,255,255,0.95); padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; z-index: 50; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 20px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }

        #bookshelf-view { overflow-y: auto; padding: 16px; }
        .book-list { display: grid; grid-template-columns: 1fr; gap: 16px; padding-bottom: 40px; }
        @media (min-width: 600px) { .book-list { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); } }
        
        /* ä¹¦æœ¬å¡ç‰‡ */
        .book-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 2px solid transparent;
            display: flex; justify-content: space-between; align-items: center;
            height: 100px; position: relative; overflow: hidden; transition: all 0.2s; cursor: pointer;
            touch-action: manipulation; 
        }
        .book-card:active { transform: scale(0.98); background: #f3f4f6; }
        
        .book-info { flex: 1; pointer-events: none; }
        .book-title { font-weight: 700; font-size: 17px; margin-bottom: 6px; color: #111827; }
        .book-meta { font-size: 13px; color: #9CA3AF; }
        .book-arrow { font-size: 20px; color: #D1D5DB; margin-left: 10px; }

        /* åˆ é™¤è’™å±‚ */
        .delete-mask {
            display: none; position: absolute; inset: 0; 
            background: rgba(254, 242, 242, 0.95); 
            border: 2px solid var(--danger); border-radius: 14px;
            z-index: 10; align-items: center; justify-content: center;
            color: var(--danger); font-weight: bold; font-size: 16px;
        }
        .delete-mask:active { background: #FECACA; }
        body.manage-mode .delete-mask { display: flex; animation: fadeIn 0.2s; }
        body.manage-mode .book-card { transform: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* è®­ç»ƒè§†å›¾ */
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--bg-body); display: flex; flex-direction: column; }
        .timer-bar { height: 6px; background: #e5e7eb; width: 100%; }
        .timer-progress { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        .training-container { flex: 1; overflow-y: auto; padding: 16px; }
        .layout-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .layout-list { display: flex; flex-direction: column; gap: 16px; }
        .word-card { background: transparent; perspective: 1000px; height: 160px; cursor: pointer; position: relative; touch-action: manipulation; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.4s; transform-style: preserve-3d; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); will-change: transform; }
        .word-card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border-radius: var(--radius); padding: 10px; }
        .card-back { transform: rotateY(180deg); background: #fafafa; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; position: absolute; top: 12px; right: 12px; background: #E5E7EB; }
        .status-dot.green { background: var(--success); } .status-dot.red { background: var(--danger); }
        .word-text { font-size: 20px; font-weight: 800; }
        .word-meaning { font-size: 15px; color: var(--text-sub); overflow-y: auto; max-height: 70px; }
        .card-actions { display: flex; gap: 10px; width: 100%; margin-top: auto; }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; color: white; touch-action: manipulation; }
        .btn-remember { background: var(--success); } .btn-forgot { background: var(--danger); }

        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: flex-end; justify-content: center; z-index: 200; backdrop-filter: blur(2px); }
        .modal { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (min-width: 600px) { .modal-overlay { align-items: center; } .modal { width: 90%; max-width: 400px; border-radius: 20px; animation: fadeIn 0.2s; } }
        
        .upload-zone { border: 2px dashed #D1D5DB; border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 12px; background: #F9FAFB; transition: 0.2s; cursor: pointer; }
        .upload-zone.active { border-color: var(--primary); background: #EEF2FF; }
        textarea { width: 100%; height: 100px; border: 1px solid #E5E7EB; border-radius: 12px; padding: 12px; font-size: 14px; margin-bottom: 10px; background: #F9FAFB; resize: none; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; z-index: 999; pointer-events: none; opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; width: max-content; }
    </style>
</head>
<body>

    <div id="bookshelf-view" class="view">
        <header>
            <button class="btn btn-ghost" onclick="App.toggleManageMode()" id="manage-btn" style="color: var(--text-sub); font-size: 14px;">âš™ï¸ ç®¡ç†</button>
            <h1>æˆ‘çš„ä¹¦æ¶</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-ghost" onclick="App.showSyncModal()">â˜ï¸</button>
                <button class="btn btn-primary" onclick="App.showImportModal()">+ å¯¼å…¥</button>
            </div>
        </header>
        <div id="book-list" class="book-list"></div>
    </div>

    <div id="training-view" class="full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="App.endTraining()">âœ• é€€å‡º</button>
            <div style="text-align: center;">
                <h1 id="train-book-title" style="font-size: 16px;">è®­ç»ƒä¸­</h1>
                <span style="font-size: 12px; color: var(--text-sub)">è½®æ¬¡ <span id="round-count">1</span></span>
            </div>
            <button class="btn btn-ghost" style="color: var(--primary)" onclick="Training.forceNextGroup()">è·³è¿‡</button>
        </header>
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        <div id="card-container" class="training-container layout-grid"></div>
        <div style="padding: 16px; border-top: 1px solid #eee; background: white; text-align: center;">
             <button class="btn btn-outline" style="width: 100%" onclick="Training.toggleLayout()">åˆ‡æ¢è§†å›¾å¸ƒå±€</button>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 style="margin-top:0">å¯¼å…¥æ–°ä¹¦</h3>
            <div class="upload-zone" onclick="document.getElementById('import-file').click()">
                <div style="font-size:24px; margin-bottom:5px">ğŸ“‚</div>
                <div style="color: #666">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (JSON/TXT)</div>
                <div id="import-file-name" style="font-size:12px; color:var(--primary); margin-top:5px; font-weight:bold;"></div>
            </div>
            <input type="file" id="import-file" class="hidden" accept=".json,.txt" onchange="App.handleFileSelect(this, 'import-file-name', 'import-name-input')">
            <div style="text-align: center; color:#999; font-size:12px; margin: 10px 0;">â€” æˆ–ç²˜è´´æ–‡æœ¬ â€”</div>
            <input type="text" id="import-name-input" placeholder="ä¹¦å (å¯é€‰)" style="width:100%; padding:12px; border:1px solid #eee; border-radius:8px; margin-bottom:8px;">
            <textarea id="import-text" placeholder='ä¾‹å¦‚: apple è‹¹æœ'></textarea>
            <button class="btn btn-primary" style="width:100%" onclick="App.processImport()">ç¡®è®¤å¯¼å…¥</button>
            <button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="App.closeModals()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="sync-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 style="margin-top:0">æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
            <div style="background: #F3F4F6; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <label style="font-weight:bold; font-size:14px;">ğŸ“¤ å¯¼å‡ºæ•°æ® (æ—§è®¾å¤‡)</label>
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <button class="btn btn-outline" style="flex:1; font-size:13px;" onclick="SyncSys.exportData()">ğŸ“‹ å¤åˆ¶æ•°æ®ç </button>
                    <button class="btn btn-outline" style="font-size:13px;" onclick="SyncSys.downloadFile()">ğŸ’¾ ä¸‹è½½å¤‡ä»½</button>
                </div>
            </div>
            <div>
                <label style="font-weight:bold; font-size:14px;">ğŸ“¥ æ¢å¤æ•°æ® (æ–°è®¾å¤‡)</label>
                <div class="upload-zone" style="padding:15px; margin-top:8px" onclick="document.getElementById('sync-file').click()">
                    <span>ğŸ“‚ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶ (æ¨è)</span>
                    <div id="sync-file-name" style="font-size:12px; color:var(--primary); font-weight:bold;"></div>
                </div>
                <input type="file" id="sync-file" class="hidden" accept=".json" onchange="SyncSys.handleFile(this)">
                
                <textarea id="sync-text" placeholder="æˆ–åœ¨æ­¤ç²˜è´´æ•°æ®ç ..." oninput="SyncSys.previewText(this.value)"></textarea>
                <div id="sync-preview" style="font-size: 12px; color: var(--text-sub); margin-bottom: 10px; text-align: center; height: 20px;"></div>
                
                <button class="btn btn-primary" style="width:100%" onclick="SyncSys.executeImport()">ğŸ”„ ç«‹å³æ¢å¤æ•°æ®</button>
            </div>
            <button class="btn btn-ghost" style="width:100%; margin-top:10px" onclick="App.closeModals()">å…³é—­</button>
        </div>
    </div>

    <div id="toast">âœ… æ“ä½œæˆåŠŸ</div>

<script>
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    toast: (msg, type='success') => {
        const t = document.getElementById('toast');
        t.innerHTML = (type==='error'?'âŒ ':'âœ… ') + msg;
        t.style.opacity = 1; t.style.top = '20px';
        setTimeout(() => { t.style.opacity = 0; t.style.top = '-50px'; }, 2500);
    },
    parseWords: (text) => {
        const words = [];
        try {
            const json = JSON.parse(text);
            const list = Array.isArray(json) ? json : (json.fullContent || []);
            list.forEach(w => { if(w.word && w.meaning) words.push({...w, id: Utils.uuid()}) });
            if(words.length > 0) return words;
        } catch(e) {}
        text.split('\n').forEach(line => {
            const p = line.split(/[\t,:-]+/);
            if(p.length >= 2 && p[0].trim().length > 0) words.push({word: p[0].trim(), meaning: p.slice(1).join(' ').trim(), id: Utils.uuid()});
        });
        return words;
    }
};

const StorageManager = {
    getKey: (id) => id.startsWith('bk_') ? id : 'bk_' + id,
    save: (id, val) => { try { localStorage.setItem(StorageManager.getKey(id), JSON.stringify(val)); } catch(e) { Utils.toast('å­˜å‚¨å·²æ»¡!', 'error'); } },
    get: (id) => { try { return JSON.parse(localStorage.getItem(StorageManager.getKey(id))); } catch(e) { return null; } },
    remove: (id) => localStorage.removeItem(StorageManager.getKey(id)),
    getAllBooks: () => {
        const books = [];
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('bk_')) { try { const b = JSON.parse(localStorage.getItem(k)); if(b && b.words) books.push(b); } catch(e) {} }
        }
        return books.sort((a,b) => b.isSystem ? 1 : -1);
    }
};

const AudioSys = {
    ctx: null,
    play: () => {
        if(!AudioSys.ctx) AudioSys.ctx = new (window.AudioContext||window.webkitAudioContext)();
        if(AudioSys.ctx.state==='suspended') AudioSys.ctx.resume();
        const osc = AudioSys.ctx.createOscillator();
        const g = AudioSys.ctx.createGain();
        osc.connect(g); g.connect(AudioSys.ctx.destination);
        osc.frequency.setValueAtTime(800, AudioSys.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(400, AudioSys.ctx.currentTime+0.1);
        g.gain.setValueAtTime(0.1, AudioSys.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, AudioSys.ctx.currentTime+0.1);
        osc.start(); osc.stop(AudioSys.ctx.currentTime+0.1);
    }
};

const SyncSys = {
    tempData: null,
    
    exportData: () => {
        const data = {};
        for(let i=0; i<localStorage.length; i++) { const k = localStorage.key(i); if(k.startsWith('bk_') || k==='layout_pref') data[k] = localStorage.getItem(k); }
        const str = JSON.stringify(data);
        if(navigator.clipboard) navigator.clipboard.writeText(str).then(()=>Utils.toast('å·²å¤åˆ¶ï¼Œè¯·å‘é€ç»™æ–°è®¾å¤‡'));
        document.getElementById('sync-text').value = str;
    },
    
    downloadFile: () => {
        const data = {};
        for(let i=0; i<localStorage.length; i++) { const k = localStorage.key(i); if(k.startsWith('bk_') || k==='layout_pref') data[k] = localStorage.getItem(k); }
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    },
    
    previewText: (str) => {
        try {
            const d = JSON.parse(str);
            const keys = Object.keys(d).filter(k => k.startsWith('bk_'));
            if(keys.length > 0) {
                SyncSys.tempData = d;
                document.getElementById('sync-preview').innerHTML = `<span style="color:var(--success)">âœ… è¯†åˆ«åˆ° ${keys.length} æœ¬ä¹¦</span>`;
            } else throw new Error();
        } catch(e) {
            SyncSys.tempData = null;
            document.getElementById('sync-preview').innerHTML = `<span style="color:orange">æ•°æ®è§£æä¸­...</span>`;
        }
    },
    
    handleFile: (input) => {
        const file = input.files[0];
        if(!file) return;
        document.getElementById('sync-file-name').innerText = file.name;
        document.getElementById('sync-preview').innerHTML = `<span style="color:orange">âŒ›ï¸ è¯»å–ä¸­...</span>`;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            SyncSys.previewText(e.target.result);
        };
        reader.onerror = () => alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
        reader.readAsText(file);
    },
    
    executeImport: () => {
        try {
            if(!SyncSys.tempData) throw new Error("è¯·å…ˆé€‰æ‹©æ–‡ä»¶æˆ–ç²˜è´´æ•°æ®");
            
            // 1. æ¸…ç©ºæ—§æ•°æ®
            const keysToRemove = [];
            for(let i=0; i<localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k.startsWith('bk_') || k==='layout_pref') keysToRemove.push(k);
            }
            keysToRemove.forEach(k => localStorage.removeItem(k));
            
            // 2. å†™å…¥æ–°æ•°æ®
            let count = 0;
            for(const k in SyncSys.tempData) {
                localStorage.setItem(k, SyncSys.tempData[k]);
                count++;
            }
            
            // 3. å¼ºåŠ›åˆ·æ–°ï¼šè¿™æ˜¯ä¿®å¤æ‰‹æœºç«¯ä¸æ›´æ–°çš„å…³é”®
            alert(`ğŸ‰ æˆåŠŸæ¢å¤ ${count} æ¡æ•°æ®ï¼\nå³å°†åˆ·æ–°é¡µé¢ç”Ÿæ•ˆ...`);
            window.location.reload(); 
            
        } catch(e) {
            alert('âŒ æ¢å¤å¤±è´¥: ' + e.message);
        }
    }
};

const Training = {
    queue: [], current: [], timer: null,
    start: (bookId) => {
        const book = StorageManager.get(bookId);
        if(!book || !book.words.length) { Utils.toast('è¿™æœ¬ä¹¦æ˜¯ç©ºçš„', 'error'); return; }
        Training.queue = [...book.words].sort(()=>0.5-Math.random());
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('training-view').classList.remove('hidden');
        document.getElementById('train-book-title').innerText = book.name;
        AudioSys.play();
        Training.next();
    },
    next: () => {
        clearInterval(Training.timer);
        AudioSys.play();
        const batch = Training.queue.splice(0, 8);
        if(!batch.length) { alert('ğŸ‰ æœ¬è½®è®­ç»ƒå®Œæˆï¼'); App.endTraining(); return; }
        Training.current = batch.map(w => ({...w, state: 0}));
        Training.render();
        let t = 60;
        const bar = document.getElementById('timer-progress');
        bar.style.transition='none'; bar.style.width='100%'; bar.offsetHeight; bar.style.transition='width 1s linear';
        Training.timer = setInterval(() => { t--; bar.style.width = (t/60)*100+'%'; if(t<=0) Training.forceNextGroup(); }, 1000);
    },
    forceNextGroup: () => {
        const left = Training.current.filter(w => w.state === 0);
        if(left.length) { Training.queue.push(...left); Utils.toast('æœªå®Œæˆå•è¯å·²æ¨å'); }
        Training.next();
    },
    action: (id, remember) => {
        const w = Training.current.find(x=>x.id===id);
        w.state = 1;
        document.getElementById('card-'+id).classList.remove('flipped');
        document.getElementById('dot-'+id).className = `status-dot ${remember?'green':'red'}`;
        if(!remember) {
            const mb = StorageManager.get(App.MISTAKE_ID);
            if(!mb.words.find(x=>x.word===w.word)) { mb.words.unshift({...w, id:Utils.uuid()}); StorageManager.save(App.MISTAKE_ID, mb); }
            Training.queue.push(w);
        }
        if(Training.current.every(x=>x.state===1)) setTimeout(Training.next, 500);
    },
    render: () => {
        const c = document.getElementById('card-container'); c.innerHTML='';
        Training.current.forEach(w => {
            const el = document.createElement('div'); el.className='word-card'; el.id='card-'+w.id;
            el.onclick = (e) => { if(e.target.tagName!=='BUTTON') el.classList.toggle('flipped'); };
            el.innerHTML = `<div class="card-inner"><div class="card-front"><div id="dot-${w.id}" class="status-dot"></div><div class="word-text">${w.word}</div></div><div class="card-back"><div class="word-meaning">${w.meaning}</div><div class="card-actions"><button class="action-btn btn-forgot" onclick="Training.action('${w.id}',false)">æ²¡è®°ä½</button><button class="action-btn btn-remember" onclick="Training.action('${w.id}',true)">è®°ä½äº†</button></div></div></div>`;
            c.appendChild(el);
        });
    },
    toggleLayout: () => {
        const c = document.getElementById('card-container');
        c.className = c.className.includes('grid') ? 'training-container layout-list' : 'training-container layout-grid';
    }
};

const App = {
    MISTAKE_ID: 'system_mistakes', 
    isManageMode: false,
    init: () => {
        if(!StorageManager.get(App.MISTAKE_ID)) StorageManager.save(App.MISTAKE_ID, {id:App.MISTAKE_ID, name:'ğŸ“… é”™é¢˜æœ¬', words:[], isSystem:true});
        App.renderList();
    },
    toggleManageMode: () => {
        App.isManageMode = !App.isManageMode;
        document.body.classList.toggle('manage-mode', App.isManageMode);
        document.getElementById('manage-btn').innerText = App.isManageMode ? 'å®Œæˆ' : 'âš™ï¸ ç®¡ç†';
        document.getElementById('manage-btn').style.color = App.isManageMode ? 'var(--primary)' : 'var(--text-sub)';
        App.renderList();
    },
    handleDelete: (bookId, event) => {
        event.stopPropagation();
        const book = StorageManager.get(bookId);
        if(book.isSystem) {
            if(confirm(`âš ï¸ è­¦å‘Šï¼šè¿™æ˜¯ç³»ç»Ÿé”™é¢˜æœ¬ï¼Œåˆ é™¤å°†æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•ï¼\n(é¡µé¢åˆ·æ–°åä¼šç”Ÿæˆæ–°çš„ç©ºæœ¬å­)\n\nç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ`)) {
                StorageManager.remove(bookId);
                App.renderList();
                if(bookId === App.MISTAKE_ID) App.init();
            }
        } else {
            if(confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿ`)) { StorageManager.remove(bookId); App.renderList(); }
        }
    },
    renderList: () => {
        const list = document.getElementById('book-list'); list.innerHTML = '';
        const books = StorageManager.getAllBooks();
        books.forEach(b => {
            const el = document.createElement('div');
            el.className = 'book-card';
            el.onclick = () => { if(!App.isManageMode) Training.start(b.id); };
            el.innerHTML = `
                <div class="book-info">
                    <div class="book-title">${b.name}</div>
                    <div class="book-meta">${b.words.length} è¯ ${b.isSystem?'(ç³»ç»Ÿ)':''}</div>
                </div>
                <div class="book-arrow">âœ</div>
                <div class="delete-mask" onclick="App.handleDelete('${b.id}', event)">ğŸ—‘ ç‚¹å‡»åˆ é™¤</div>
            `;
            list.appendChild(el);
        });
        if(books.length === 0) list.innerHTML = '<div style="text-align:center;color:#999;padding:40px">ä¹¦æ¶æ˜¯ç©ºçš„</div>';
    },
    processImport: () => {
        const text = document.getElementById('import-text').value;
        const name = document.getElementById('import-name-input').value;
        if(text.includes('bk_') && text.includes('layout_pref')) { alert('ğŸ›‘ é”™è¯¯ï¼šè¿™æ˜¯ç³»ç»Ÿå¤‡ä»½æ–‡ä»¶ï¼Œè¯·å»â˜ï¸åŒæ­¥çª—å£æ¢å¤ã€‚'); return; }
        const words = Utils.parseWords(text);
        if(words.length === 0) { Utils.toast('æ— æ³•è¯†åˆ«å†…å®¹', 'error'); return; }
        StorageManager.save(Utils.uuid(), { id: Utils.uuid(), name: name || 'æ–°ä¹¦ '+new Date().toLocaleDateString(), words: words, isSystem: false });
        App.closeModals(); App.renderList(); Utils.toast(`å¯¼å…¥ ${words.length} ä¸ªå•è¯`);
    },
    showImportModal: () => { document.getElementById('import-modal').classList.remove('hidden'); },
    showSyncModal: () => { document.getElementById('sync-modal').classList.remove('hidden'); document.getElementById('sync-preview').innerHTML=''; SyncSys.tempData=null; },
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.add('hidden')),
    handleFileSelect: (input, nameId, textNameId) => {
        if(input.files[0]) {
            document.getElementById(nameId).innerText = input.files[0].name;
            if(textNameId) document.getElementById(textNameId).value = input.files[0].name.replace(/\.[^/.]+$/, "");
            if(input.id === 'import-file') { const r = new FileReader(); r.onload = (e) => document.getElementById('import-text').value = e.target.result; r.readAsText(input.files[0]); }
        }
    },
    endTraining: () => { clearInterval(Training.timer); document.getElementById('training-view').classList.add('hidden'); document.getElementById('bookshelf-view').classList.remove('hidden'); App.renderList(); }
};

window.onload = App.init;
</script>
</body>
</html>
