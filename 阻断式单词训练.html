<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜»æ–­å¼å•è¯è®­ç»ƒå™¨ (Pro+)</title>
    <style>
        :root {
            --primary: #4F46E5; /* Indigo 600 */
            --primary-dark: #4338ca;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --success: #10B981;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font-stack); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* é€šç”¨ç»„ä»¶ */
        .btn { border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-outline { border: 1px solid #d1d5db; background: white; color: var(--text-main); }
        
        .hidden { display: none !important; }
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: var(--bg-body); display: flex; flex-direction: column; }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-zone {
            border: 2px dashed #d1d5db; border-radius: 8px; padding: 15px; text-align: center;
            margin-bottom: 10px; cursor: pointer; transition: border-color 0.2s; background: #fafafa;
        }
        .upload-zone:hover { border-color: var(--primary); background: #f0fdf4; }
        .file-name-tag { font-size: 12px; color: var(--primary); font-weight: bold; display: block; margin-top: 4px; word-break: break-all; }

        /* Header & Bookshelf */
        header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); z-index: 50; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 18px; font-weight: 700; color: var(--primary); }

        #bookshelf-view { flex: 1; overflow-y: auto; padding: 16px; }
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; }
        .book-card { background: var(--bg-card); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow-sm); position: relative; transition: transform 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 140px; border: 1px solid rgba(0,0,0,0.02); }
        .book-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .book-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .book-meta { font-size: 12px; color: var(--text-sub); }
        .book-special { border: 2px solid var(--danger); }
        .add-book-card { border: 2px dashed #d1d5db; background: transparent; color: var(--text-sub); align-items: center; justify-content: center; cursor: pointer; }

        /* Training View */
        .training-container { flex: 1; overflow-y: auto; padding: 16px; }
        .layout-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; align-content: start; }
        @media (min-width: 600px) { .layout-grid { grid-template-columns: repeat(4, 1fr); } }
        .layout-list { display: flex; flex-direction: column; gap: 16px; max-width: 600px; margin: 0 auto; }
        .layout-list .word-card { height: 200px; font-size: 1.2em; }

        .word-card { background: transparent; perspective: 1000px; height: 140px; cursor: pointer; position: relative; user-select: none; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.4s; transform-style: preserve-3d; border-radius: var(--radius); box-shadow: var(--shadow-md); will-change: transform; }
        .word-card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border-radius: var(--radius); padding: 10px; }
        .card-back { transform: rotateY(180deg); background: #fafafa; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; position: absolute; top: 10px; right: 10px; background: #d1d5db; }
        .status-dot.green { background: var(--success); } .status-dot.red { background: var(--danger); }
        .word-text { font-size: 18px; font-weight: 700; word-break: break-all; }
        .word-meaning { font-size: 14px; color: var(--text-sub); margin-bottom: 10px; overflow-y: auto; max-height: 60px; }
        .review-tag { position: absolute; top: 8px; left: 8px; font-size: 10px; background: #FEF3C7; color: #D97706; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        .timer-bar { height: 4px; background: #e5e7eb; width: 100%; }
        .timer-progress { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
        .bottom-controls { padding: 12px 16px; background: white; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 200; }
        .modal { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: var(--radius); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
        textarea { width: 100%; height: 80px; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px; margin: 5px 0; font-family: monospace; resize: none; }
        
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(31, 41, 55, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 300; }
    </style>
</head>
<body>

    <div id="bookshelf-view" class="view">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h1>ğŸ“š æˆ‘çš„ä¹¦æ¶</h1>
                <button class="btn btn-ghost" style="padding: 4px;" onclick="App.showSyncModal()">â˜ï¸</button>
            </div>
            <button class="btn btn-primary" onclick="App.showImportModal()">+ å¯¼å…¥</button>
        </header>
        <div id="book-list" class="book-list"></div>
        <div style="margin-top: 20px; text-align: center; color: #9ca3af; font-size: 12px;">
            å­˜å‚¨çŠ¶æ€: <span id="storage-status">Checking...</span>
        </div>
    </div>

    <div id="training-view" class="view full-screen hidden">
        <header>
            <button class="btn btn-ghost" onclick="App.endTraining()">é€€å‡º</button>
            <div style="text-align: center;">
                <h1 id="train-book-title">è®­ç»ƒä¸­</h1>
                <span style="font-size: 10px; color: var(--text-sub)">ç¬¬ <span id="round-count">1</span> è½® | ç»„å‰©ä½™: <span id="group-remain">0</span></span>
            </div>
            <button class="btn btn-ghost" style="color: var(--primary)" onclick="Training.forceNextGroup()">è·³è¿‡</button>
        </header>
        <div class="timer-bar"><div id="timer-progress" class="timer-progress"></div></div>
        <div id="card-container" class="training-container layout-grid"></div>
        <div class="bottom-controls">
            <button class="btn btn-outline" id="layout-toggle" onclick="Training.toggleLayout()">âŠ åˆ‡æ¢è§†å›¾</button>
            <span style="font-size: 12px; color: var(--text-sub)">ç‚¹å‡»å¡ç‰‡ç¿»é¢</span>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>å¯¼å…¥å•è¯ä¹¦</h3>
            
            <div class="upload-zone" onclick="document.getElementById('import-file-input').click()">
                <div style="font-size:24px;">ğŸ“‚</div>
                <div style="font-size:14px; color:#4b5563;">ç‚¹å‡»é€‰æ‹© JSON / TXT æ–‡ä»¶</div>
                <span id="import-filename" class="file-name-tag"></span>
            </div>
            <input type="file" id="import-file-input" accept=".json,.txt" class="hidden" onchange="App.handleFileSelect(this, 'import-filename', 'import-name')">

            <div style="text-align: center; font-size: 12px; color: #9ca3af; margin: 8px 0;">â€” æˆ–è€…ç²˜è´´æ–‡æœ¬ â€”</div>
            
            <input type="text" id="import-name" placeholder="ä¹¦å (è‡ªåŠ¨å¡«å……)" style="width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <textarea id="import-content" placeholder='ç›´æ¥ç²˜è´´ [{"word":"...", "meaning":"..."}]'></textarea>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                <button class="btn btn-ghost" onclick="App.closeModals()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="App.processImport()">å¼€å§‹å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3>â˜ï¸ æ•°æ®åŒæ­¥ä¸å¤‡ä»½</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="font-size: 12px; font-weight: bold;">1. å¯¼å‡º (æ—§è®¾å¤‡)</label>
                <div style="display: flex; gap: 8px; margin-top: 5px;">
                    <button class="btn btn-outline" style="flex: 1;" onclick="SyncSys.exportData()">ğŸ“‹ å¤åˆ¶å¤‡ä»½ç </button>
                    <button class="btn btn-outline" onclick="SyncSys.downloadFile()">ğŸ’¾ ä¸‹è½½æ–‡ä»¶</button>
                </div>
            </div>

            <div>
                <label style="font-size: 12px; font-weight: bold;">2. æ¢å¤ (æ–°è®¾å¤‡)</label>
                
                <div class="upload-zone" style="padding: 10px; margin-top:5px;" onclick="document.getElementById('sync-file-input').click()">
                    <span style="font-size:12px;">ğŸ“‚ ç‚¹å‡»ä¸Šä¼ å¤‡ä»½æ–‡ä»¶ (.json)</span>
                    <span id="sync-filename" class="file-name-tag"></span>
                </div>
                <input type="file" id="sync-file-input" accept=".json" class="hidden" onchange="App.handleFileSelect(this, 'sync-filename')">

                <textarea id="sync-input" placeholder="...æˆ–è€…åœ¨æ­¤ç²˜è´´å¤‡ä»½ç " style="height: 50px; margin-top:0;"></textarea>
                <button class="btn btn-primary" style="width: 100%; margin-top: 8px;" onclick="SyncSys.importData()">ğŸ”„ è¦†ç›–å¹¶æ¢å¤æ•°æ®</button>
            </div>

            <div style="margin-top: 15px; text-align: right;">
                <button class="btn btn-ghost" onclick="App.closeModals()">å…³é—­</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

<script>
/** æ ¸å¿ƒæœåŠ¡ */
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    toast: (msg) => {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    },
    extractWords: (text) => {
        const words = [];
        const regexJSON = /word["']?\s*:\s*["'](.*?)["'][\s\S]*?meaning["']?\s*:\s*["'](.*?)["']/gi;
        let match;
        while ((match = regexJSON.exec(text)) !== null) {
            if(match[1] && match[2]) words.push({ word: match[1], meaning: match[2], id: Utils.uuid() });
        }
        if (words.length === 0) {
            text.split('\n').forEach(line => {
                const parts = line.split(/[\t,:-]+/);
                if(parts.length >= 2 && parts[0].length > 1) words.push({ word: parts[0].trim(), meaning: parts.slice(1).join(' ').trim(), id: Utils.uuid() });
            });
        }
        return words;
    }
};

const AudioSys = {
    ctx: null,
    init: () => {
        if (!AudioSys.ctx) { AudioSys.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
    },
    beep: () => {
        if (!AudioSys.ctx) return;
        if (AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
        const osc = AudioSys.ctx.createOscillator();
        const gain = AudioSys.ctx.createGain();
        osc.connect(gain); gain.connect(AudioSys.ctx.destination);
        osc.frequency.setValueAtTime(880, AudioSys.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(440, AudioSys.ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, AudioSys.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime + 0.1);
        osc.start(); osc.stop(AudioSys.ctx.currentTime + 0.15);
    }
};

const StorageSys = {
    mode: 'local', ramCache: {},
    init: () => {
        try { localStorage.setItem('_t', '1'); localStorage.removeItem('_t'); StorageSys.mode = 'local'; document.getElementById('storage-status').innerText = 'æ­£å¸¸ (Disk)'; }
        catch (e) { StorageSys.mode = 'ram'; document.getElementById('storage-status').innerText = 'RAM æ¨¡å¼'; Utils.toast('å­˜å‚¨å·²æ»¡ï¼Œä»…å†…å­˜å¯ç”¨'); }
        if (!StorageSys.getBook(App.MISTAKE_BOOK_ID)) StorageSys.saveBook({ id: App.MISTAKE_BOOK_ID, name: 'ğŸ“… é”™é¢˜æœ¬', words: [], isSystem: true });
    },
    getBooksMeta: () => {
        if (StorageSys.mode === 'ram') return Object.values(StorageSys.ramCache).map(b => ({id:b.id, name:b.name, count:b.words.length, isSystem:b.isSystem}));
        const books = [];
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('bk_')) { try { const b=JSON.parse(localStorage.getItem(k)); books.push({id:b.id, name:b.name, count:b.words.length, isSystem:b.isSystem}); } catch(e){} }
        }
        return books.sort((a,b) => b.isSystem ? 1 : -1);
    },
    getBook: (id) => StorageSys.mode === 'ram' ? StorageSys.ramCache[id] : JSON.parse(localStorage.getItem('bk_'+id)),
    saveBook: (b) => {
        try { if(StorageSys.mode==='local') localStorage.setItem('bk_'+b.id, JSON.stringify(b)); else StorageSys.ramCache[b.id]=b; }
        catch(e) { StorageSys.mode='ram'; StorageSys.ramCache[b.id]=b; Utils.toast('è½¬å…¥å†…å­˜æ¨¡å¼'); }
    },
    deleteBook: (id) => { if(StorageSys.mode==='local') localStorage.removeItem('bk_'+id); else delete StorageSys.ramCache[id]; },
    addToMistakes: (w) => {
        const mb = StorageSys.getBook(App.MISTAKE_BOOK_ID);
        if(!mb.words.find(exist => exist.word === w.word)) { mb.words.unshift({...w, id:Utils.uuid()}); StorageSys.saveBook(mb); }
    }
};

const SyncSys = {
    getAllData: () => {
        const d = {};
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('bk_') || k === 'layout_pref') d[k] = localStorage.getItem(k);
        }
        return JSON.stringify(d);
    },
    exportData: () => {
        const json = SyncSys.getAllData();
        if(navigator.clipboard) navigator.clipboard.writeText(json).then(()=>Utils.toast('âœ… å·²å¤åˆ¶å¤‡ä»½ç ')).catch(()=>{});
        document.getElementById('sync-input').value = json; // fallback UI
    },
    downloadFile: () => {
        const blob = new Blob([SyncSys.getAllData()], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `å•è¯å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    },
    importData: () => {
        const fileInput = document.getElementById('sync-file-input');
        const file = fileInput.files[0];
        const textVal = document.getElementById('sync-input').value.trim();

        const runImport = (jsonStr) => {
            if (!jsonStr) { Utils.toast('âš ï¸ æ— å†…å®¹'); return; }
            if (!confirm('ç¡®å®šè¦†ç›–å½“å‰æ•°æ®å—ï¼Ÿ')) return;
            try {
                const data = JSON.parse(jsonStr);
                let c = 0;
                for(const k in data) { if(k.startsWith('bk_') || k==='layout_pref') { localStorage.setItem(k, data[k]); c++; } }
                App.closeModals(); App.renderBookshelf(); Utils.toast(`âœ… æ¢å¤äº† ${c} é¡¹æ•°æ®`);
            } catch(e) { alert('âŒ æ•°æ®æŸåæˆ–æ ¼å¼é”™è¯¯'); }
        };

        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => runImport(e.target.result);
            reader.readAsText(file);
        } else {
            runImport(textVal);
        }
    }
};

/** è®­ç»ƒé€»è¾‘ */
const Training = {
    currentBook: null, queue: [], currentGroup: [], mistakesBuffer: [],
    timer: null, timeLeft: 60, roundsCompleted: 0, layout: 'grid',
    
    start: (bookId) => {
        Training.currentBook = StorageSys.getBook(bookId);
        if(!Training.currentBook || !Training.currentBook.words.length) { Utils.toast('ç©ºä¹¦ï¼'); return; }
        Training.queue = [...Training.currentBook.words].sort(()=>0.5-Math.random());
        Training.mistakesBuffer = []; Training.roundsCompleted = 0;
        document.getElementById('bookshelf-view').classList.add('hidden');
        document.getElementById('training-view').classList.remove('hidden');
        document.getElementById('train-book-title').innerText = Training.currentBook.name;
        const saved = localStorage.getItem('layout_pref'); if(saved) Training.setLayout(saved);
        AudioSys.init(); Training.nextGroup();
    },
    nextGroup: () => {
        clearInterval(Training.timer); AudioSys.beep(); Training.roundsCompleted++;
        let batch = Training.queue.splice(0, 8);
        if(Training.roundsCompleted % 3 === 0 && Training.mistakesBuffer.length) {
            batch = batch.concat(Training.mistakesBuffer.splice(0, 2).map(w => ({...w, isReview:true})));
        }
        if(!batch.length) {
            if(Training.mistakesBuffer.length) { Training.queue = Training.mistakesBuffer; Training.mistakesBuffer=[]; Training.nextGroup(); }
            else { alert('ğŸ‰ å®Œæˆï¼'); App.endTraining(); }
            return;
        }
        Training.currentGroup = batch.map(w => ({...w, status:'pending'}));
        Training.renderCards(); Training.startTimer(); Training.updateStats();
    },
    startTimer: () => {
        Training.timeLeft = 60;
        const bar = document.getElementById('timer-progress');
        bar.style.transition='none'; bar.style.width='100%'; bar.offsetHeight; bar.style.transition='width 1s linear';
        Training.timer = setInterval(() => {
            Training.timeLeft--;
            bar.style.width = `${(Training.timeLeft/60)*100}%`;
            if(Training.timeLeft<=0) Training.forceNextGroup();
        }, 1000);
    },
    forceNextGroup: () => {
        const p = Training.currentGroup.filter(w=>w.status==='pending');
        if(p.length) { Training.queue.push(...p); Utils.toast('æœªå®Œæˆå•è¯å·²æ¨å'); }
        Training.nextGroup();
    },
    handleCardAction: (id, type) => {
        const item = Training.currentGroup.find(w=>w.id===id); if(!item) return;
        const el = document.getElementById(`card-${id}`);
        const dot = el.querySelector('.status-dot');
        if(type === 'remember') { item.status='remembered'; dot.className='status-dot green'; }
        else { item.status='forgot'; dot.className='status-dot red'; Training.mistakesBuffer.push(item); StorageSys.addToMistakes(item); }
        el.classList.remove('flipped');
        if(Training.currentGroup.every(w=>w.status==='remembered')) setTimeout(Training.nextGroup, 500);
    },
    renderCards: () => {
        const c = document.getElementById('card-container'); c.innerHTML='';
        Training.currentGroup.forEach(i => {
            const el = document.createElement('div'); el.className='word-card'; el.id=`card-${i.id}`;
            el.onclick=(e)=>{if(e.target.tagName!=='BUTTON')el.classList.toggle('flipped')};
            el.innerHTML=`<div class="card-inner">
                <div class="card-front">${i.isReview?'<div class="review-tag">å¤ä¹ </div>':''}<div class="status-dot"></div><div class="word-text">${i.word}</div></div>
                <div class="card-back"><div class="word-meaning">${i.meaning}</div><div class="card-actions">
                <button class="action-btn btn-forgot" onclick="Training.handleCardAction('${i.id}','forgot')">æ²¡è®°ä½</button>
                <button class="action-btn btn-remember" onclick="Training.handleCardAction('${i.id}','remember')">è®°ä½äº†</button></div></div></div>`;
            c.appendChild(el);
        });
    },
    updateStats: () => { document.getElementById('round-count').innerText=Training.roundsCompleted; document.getElementById('group-remain').innerText=Training.currentGroup.length; },
    toggleLayout: () => { Training.setLayout(Training.layout==='grid'?'list':'grid'); },
    setLayout: (m) => {
        Training.layout=m; const c=document.getElementById('card-container');
        if(m==='grid'){c.classList.remove('layout-list');c.classList.add('layout-grid');document.getElementById('layout-toggle').innerText='âŠ åˆ‡æ¢è§†å›¾';}
        else{c.classList.remove('layout-grid');c.classList.add('layout-list');document.getElementById('layout-toggle').innerText='â–¢ åˆ‡æ¢è§†å›¾';}
        localStorage.setItem('layout_pref',m);
    }
};

/** åº”ç”¨ä¸»æ§ */
const App = {
    MISTAKE_BOOK_ID: 'mistake_notebook',
    init: () => { StorageSys.init(); App.renderBookshelf(); },
    renderBookshelf: () => {
        const list = document.getElementById('book-list'); list.innerHTML='';
        StorageSys.getBooksMeta().forEach(b => {
            const el = document.createElement('div'); el.className=`book-card ${b.isSystem?'book-special':''}`;
            el.innerHTML=`<div><div class="book-title">${b.name}</div><div class="book-meta">${b.count} è¯</div></div>
                <div class="book-actions">${!b.isSystem?`<button class="btn btn-outline" style="padding:4px 8px;font-size:12px;" onclick="App.deleteBook('${b.id}',event)">åˆ </button>`:''}<button class="btn btn-primary" onclick="Training.start('${b.id}')">è¿›å…¥</button></div>`;
            list.appendChild(el);
        });
        const add = document.createElement('div'); add.className='book-card add-book-card';
        add.innerHTML='<div style="font-size:32px;">+</div><div>å¯¼å…¥ä¹¦æœ¬</div>';
        add.onclick=App.showImportModal; list.appendChild(add);
    },
    
    // UI Logic
    showImportModal: () => {
        document.getElementById('import-modal').classList.remove('hidden');
        ['import-name','import-content','import-file-input'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('import-filename').innerText = '';
    },
    showSyncModal: () => {
        document.getElementById('sync-modal').classList.remove('hidden');
        ['sync-input','sync-file-input'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('sync-filename').innerText = '';
    },
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(el=>el.classList.add('hidden')),
    
    // File Logic
    handleFileSelect: (input, labelId, nameInputId) => {
        if(input.files && input.files[0]) {
            const f = input.files[0];
            document.getElementById(labelId).innerText = f.name;
            if(nameInputId) {
                const nameIn = document.getElementById(nameInputId);
                if(!nameIn.value) nameIn.value = f.name.replace(/\.[^/.]+$/, "");
            }
        }
    },
    processImport: () => {
        const fileInput = document.getElementById('import-file-input');
        const file = fileInput.files[0];
        const textVal = document.getElementById('import-content').value;
        const nameVal = document.getElementById('import-name').value;

        const runImport = (content, filename) => {
            if(!content.trim()) return;
            let words = [];
            try {
                const json = JSON.parse(content);
                if(Array.isArray(json)) words = json.map(w=>({word:w.word, meaning:w.meaning, id:Utils.uuid()}));
                else if(json.fullContent) words = json.fullContent.map(w=>({word:w.word, meaning:w.meaning, id:Utils.uuid()}));
            } catch(e) {}
            if(!words.length) words = Utils.extractWords(content);
            if(!words.length) { alert('æ— æ³•è§£æå†…å®¹'); return; }
            
            StorageSys.saveBook({ id: Utils.uuid(), name: nameVal || filename || 'æ–°ä¹¦ '+new Date().toLocaleDateString(), words: words, isSystem: false });
            App.closeModals(); App.renderBookshelf(); Utils.toast(`æˆåŠŸå¯¼å…¥ ${words.length} ä¸ªå•è¯`);
        };

        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => runImport(e.target.result, file.name.replace(/\.[^/.]+$/, ""));
            reader.readAsText(file);
        } else if (textVal) {
            runImport(textVal, '');
        } else {
            Utils.toast('è¯·é€‰æ‹©æ–‡ä»¶æˆ–è¾“å…¥å†…å®¹');
        }
    },
    
    deleteBook: (id,e) => { e.stopPropagation(); if(confirm('åˆ é™¤æ­¤ä¹¦ï¼Ÿ')) { StorageSys.deleteBook(id); App.renderBookshelf(); } },
    endTraining: () => { clearInterval(Training.timer); document.getElementById('training-view').classList.add('hidden'); document.getElementById('bookshelf-view').classList.remove('hidden'); App.renderBookshelf(); }
};

window.onload = App.init;
</script>
</body>
</html>
